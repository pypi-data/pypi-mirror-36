
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Using mypy with an existing codebase &#8212; Mypy 0.630+dev-734a166d380bfb0de05ce0e3c61dc7e675898e9c-dirty documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Type hints cheat sheet (Python 3)" href="cheat_sheet_py3.html" />
    <link rel="prev" title="Getting started" href="getting_started.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cheat_sheet_py3.html" title="Type hints cheat sheet (Python 3)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Getting started"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Mypy 0.630+dev-734a166d380bfb0de05ce0e3c61dc7e675898e9c-dirty documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-mypy-with-an-existing-codebase">
<span id="existing-code"></span><h1>Using mypy with an existing codebase<a class="headerlink" href="#using-mypy-with-an-existing-codebase" title="Permalink to this headline">¶</a></h1>
<p>This section explains how to get started using mypy with an existing,
significant codebase that has little or no type annotations. If you are
a beginner, you can skip this section.</p>
<p>These steps will get you started with mypy on an existing codebase:</p>
<ol class="arabic simple">
<li>Start small – get a clean mypy build for some files, with few
annotations</li>
<li>Write a mypy runner script to ensure consistent results</li>
<li>Run mypy in Continuous Integration to prevent type errors</li>
<li>Gradually annotate commonly imported modules</li>
<li>Write annotations as you modify existing code and write new code</li>
<li>Use MonkeyType or PyAnnotate to automatically annotate legacy code</li>
</ol>
<p>We discuss all of these points in some detail below, and a few optional
follow-up steps.</p>
<div class="section" id="start-small">
<h2>Start small<a class="headerlink" href="#start-small" title="Permalink to this headline">¶</a></h2>
<p>If your codebase is large, pick a subset of your codebase (say, 5,000
to 50,000 lines) and run mypy only on this subset at first,
<em>without any annotations</em>. This shouldn’t take more than a day or two
to implement, so you start enjoying benefits soon.</p>
<p>You’ll likely need to fix some mypy errors, either by inserting
annotations requested by mypy or by adding <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">type:</span> <span class="pre">ignore</span></code>
comments to silence errors you don’t want to fix now.</p>
<p>In particular, mypy often generates errors about modules that it can’t
find or that don’t have stub files:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>core/config.py:7: error: Cannot find module named &#39;frobnicate&#39;
core/model.py:9: error: Cannot find module named &#39;acme&#39;
...
</pre></div>
</div>
<p>This is normal, and you can easily ignore these errors. For example,
here we ignore an error about a third-party module <code class="docutils literal notranslate"><span class="pre">frobnicate</span></code> that
doesn’t have stubs using <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">type:</span> <span class="pre">ignore</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">frobnicate</span>  <span class="c1"># type: ignore</span>
<span class="o">...</span>
<span class="n">frobnicate</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>  <span class="c1"># OK (but not checked)</span>
</pre></div>
</div>
<p>You can also use a mypy configuration file, which is convenient if
there are a large number of errors to ignore. For example, to disable
errors about importing <code class="docutils literal notranslate"><span class="pre">frobnicate</span></code> and <code class="docutils literal notranslate"><span class="pre">acme</span></code> everywhere in your
codebase, use a config like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[mypy-frobnicate.*]
ignore_missing_imports = True

[mypy-acme.*]
ignore_missing_imports = True
</pre></div>
</div>
<p>You can add multiple sections for different modules that should be
ignored.</p>
<p>If your config file is named <code class="docutils literal notranslate"><span class="pre">mypy.ini</span></code>, this is how you run mypy:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mypy --config-file mypy.ini mycode/
</pre></div>
</div>
<p>If you get a large number of errors, you may want to ignore all errors
about missing imports.  This can easily cause problems later on and
hide real errors, and it’s only recommended as a last resort.
For more details, look <a class="reference internal" href="running_mypy.html#follow-imports"><span class="std std-ref">here</span></a>.</p>
<p>Mypy follows imports by default. This can result in a few files passed
on the command line causing mypy to process a large number of imported
files, resulting in lots of errors you don’t want to deal with at the
moment. There is a config file option to disable this behavior, but
since this can hide errors, it’s not recommended for most users.</p>
</div>
<div class="section" id="mypy-runner-script">
<h2>Mypy runner script<a class="headerlink" href="#mypy-runner-script" title="Permalink to this headline">¶</a></h2>
<p>Introduce a mypy runner script that runs mypy, so that every developer
will use mypy consistently. Here are some things you may want to do in
the script:</p>
<ul class="simple">
<li>Ensure that the correct version of mypy is installed.</li>
<li>Specify mypy config file or command-line options.</li>
<li>Provide set of files to type check. You may want to implement
inclusion and exclusion filters for full control of the file
list.</li>
</ul>
</div>
<div class="section" id="continuous-integration">
<h2>Continuous Integration<a class="headerlink" href="#continuous-integration" title="Permalink to this headline">¶</a></h2>
<p>Once you have a clean mypy run and a runner script for a part
of your codebase, set up your Continuous Integration (CI) system to
run mypy to ensure that developers won’t introduce bad annotations.
A simple CI script could look something like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>python3 -m pip install mypy==0.600  # Pinned version avoids surprises
scripts/mypy  # Runs with the correct options
</pre></div>
</div>
</div>
<div class="section" id="annotate-widely-imported-modules">
<h2>Annotate widely imported modules<a class="headerlink" href="#annotate-widely-imported-modules" title="Permalink to this headline">¶</a></h2>
<p>Most projects have some widely imported modules, such as utilities or
model classes. It’s a good idea to annotate these pretty early on,
since this allows code using these modules to be type checked more
effectively. Since mypy supports gradual typing, it’s okay to leave
some of these modules unannotated. The more you annotate, the more
useful mypy will be, but even a little annotation coverage is useful.</p>
</div>
<div class="section" id="write-annotations-as-you-go">
<h2>Write annotations as you go<a class="headerlink" href="#write-annotations-as-you-go" title="Permalink to this headline">¶</a></h2>
<p>Now you are ready to include type annotations in your development
workflows. Consider adding something like these in your code style
conventions:</p>
<ol class="arabic simple">
<li>Developers should add annotations for any new code.</li>
<li>It’s also encouraged to write annotations when you modify existing code.</li>
</ol>
<p>This way you’ll gradually increase annotation coverage in your
codebase without much effort.</p>
</div>
<div class="section" id="automate-annotation-of-legacy-code">
<h2>Automate annotation of legacy code<a class="headerlink" href="#automate-annotation-of-legacy-code" title="Permalink to this headline">¶</a></h2>
<p>There are tools for automatically adding draft annotations
based on type profiles collected at runtime.  Tools include
<a class="reference external" href="https://github.com/Instagram/MonkeyType">MonkeyType</a>
(Python 3) and <a class="reference external" href="https://github.com/dropbox/pyannotate">PyAnnotate</a>
(type comments only).</p>
<p>A simple approach is to collect types from test runs. This may work
well if your test coverage is good (and if your tests aren’t very
slow).</p>
<p>Another approach is to enable type collection for a small, random
fraction of production network requests.  This clearly requires more
care, as type collection could impact the reliability or the
performance of your service.</p>
</div>
<div class="section" id="speed-up-mypy-runs">
<h2>Speed up mypy runs<a class="headerlink" href="#speed-up-mypy-runs" title="Permalink to this headline">¶</a></h2>
<p>You can use <a class="reference internal" href="mypy_daemon.html#mypy-daemon"><span class="std std-ref">mypy daemon</span></a> to get much faster
incremental mypy runs. The larger your project is, the more useful
this will be.  If your project has at least 100,000 lines of code or
so, you may also want to set up <a class="reference internal" href="additional_features.html#remote-cache"><span class="std std-ref">remote caching</span></a>
for further speedups.</p>
</div>
<div class="section" id="introduce-stricter-options">
<h2>Introduce stricter options<a class="headerlink" href="#introduce-stricter-options" title="Permalink to this headline">¶</a></h2>
<p>Mypy is very configurable. Once you get started with static typing,
you may want to explore the various
strictness options mypy provides to
catch more bugs. For example, you can ask mypy to require annotations
for all functions in certain modules to avoid accidentally introducing
code that won’t be type checked. Refer to <a class="reference internal" href="command_line.html#command-line"><span class="std std-ref">The mypy command line</span></a> for the
details.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using mypy with an existing codebase</a><ul>
<li><a class="reference internal" href="#start-small">Start small</a></li>
<li><a class="reference internal" href="#mypy-runner-script">Mypy runner script</a></li>
<li><a class="reference internal" href="#continuous-integration">Continuous Integration</a></li>
<li><a class="reference internal" href="#annotate-widely-imported-modules">Annotate widely imported modules</a></li>
<li><a class="reference internal" href="#write-annotations-as-you-go">Write annotations as you go</a></li>
<li><a class="reference internal" href="#automate-annotation-of-legacy-code">Automate annotation of legacy code</a></li>
<li><a class="reference internal" href="#speed-up-mypy-runs">Speed up mypy runs</a></li>
<li><a class="reference internal" href="#introduce-stricter-options">Introduce stricter options</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="getting_started.html"
                        title="previous chapter">Getting started</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="cheat_sheet_py3.html"
                        title="next chapter">Type hints cheat sheet (Python 3)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/existing_code.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cheat_sheet_py3.html" title="Type hints cheat sheet (Python 3)"
             >next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Getting started"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Mypy 0.630+dev-734a166d380bfb0de05ce0e3c61dc7e675898e9c-dirty documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Jukka Lehtosalo.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>