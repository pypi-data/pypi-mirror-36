"use strict";var Picotable=function(v,n){v=v||require("mithril");var p=function(){function t(t,n){return Array.isArray(t)?t.map(n):Object.keys(t).map(function(e){return n(t[e],e,t)})}return{property:function(t){return function(e){return e[t]}},map:t,any:function(t,n){return Array.isArray(t)?t.some(n):Object.keys(t).some(function(e){return n(t[e],e,t)})},extend:function(){for(var e=arguments[0],t=1;t<arguments.length;t++)for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},trim:function(e){return(""+e).replace(/^\s+|\s+$/g,"")},omitNulls:function(e){var n={};return t(e,function(e,t){null!==e&&(n[t]=e)}),n},debounce:function(t,n){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=void 0,l=void 0,a=void 0,o=void 0,s=void 0;function c(){var e=(new Date).getTime()-a;e<n&&0<e?o=setTimeout(c,n-e):(o=null,i||(s=t.apply(r,l),r=l=null),v.endComputation())}return function(){return r=this,l=arguments,a=(new Date).getTime(),o||(v.startComputation(),o=setTimeout(c,n),i&&(s=t.apply(r,l),r=l=null)),s}},stringValue:function(e){return null==e?"":Array.isArray(e)&&0===e.length?"":""+e},isEmpty:function(e){if(e.length)return!1;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},boundPartial:function(t,n){var i=[].slice.call(arguments,2);return function(){var e=i.concat([].slice.call(arguments));return n.apply(t,e)}}}}(),d={MASS_ACTIONS:gettext("Mass actions"),RANGE_FROM:gettext("From"),RANGE_TO:gettext("To"),ITEMS_PER_PAGE:gettext("Items per page"),PAGE:gettext("Page"),RESET_FILTERS:gettext("Reset filters"),RESET:gettext("Reset"),SORT_BY:gettext("Sort by"),SORT_ASC:gettext("ascending"),SORT_DESC:gettext("descending"),SORT_DEFAULT:gettext("Default sorting")},g=function(e){var i=[];return p.map(e||{},function(e,t){var n=null;(n=""===t?e&&e.length?""+e:null:e?t:null)&&i.push(n)}),i.join(" ")};function h(e,t){if(0===e.nItems)return v("nav");for(var n=v.withAttr("rel",t),i=e.pageNum,r=[],l=function(e,t){return v("a",{rel:e,href:"#",onclick:n},t||e)},a=1;a<=e.nPages;a++)if(1===a||a===e.nPages||Math.abs(a-i)<=2){var o=v("li",{key:a,className:g({active:i===a})},l(a));o._page=a,r.push(o)}!function(e){for(var t=0,n=1;n<e.length;n++)if(e[n]._page!==e[n-1]._page+1){var i=v("li",{key:"dummy"+t++,className:"disabled"},v("a",{href:"#"},"â‹¯"));e.splice(n,0,i),n++}}(r);var s=v("li",{key:"previous",className:g({disabled:1===i})},l(i-1,gettext("Previous"))),c=v("li",{key:"next",className:g({disabled:i===e.nPages})},l(i+1,gettext("Next")));return v("nav",v("ul.pagination",s,r,c))}function m(i){return function(e,t,n){t||(e.oninput=n.debouncedOnInput=p.debounce(e.onchange,i))}}function b(e){for(var t=e.vm.data(),n={},i=0;i<t.columns.length;i++)if(t.columns[i].filter){var r=t.columns[i].filter.defaultChoice;r&&(n[t.columns[i].id]=r)}return n}function w(e,t){var n,i,r,l,a,o,s,c,u=e.getFilterValue(t.id);return t.filter.choices?(n=e,r=u,l=v("select.form-control",{config:(i=t).filter.select2?function(e,t){t||$(e).select2()}:null,value:JSON.stringify(r),onchange:function(){var e=JSON.parse(this.value);n.setFilterValue(i.id,e)}},p.map(i.filter.choices,function(e){return v("option",{value:JSON.stringify(e[0]),key:e[0]},e[1])})),v("div.choice-filter",l)):t.filter.range?function(i,r,e){var t=function(e){var t=p.extend({},i.getFilterValue(r.id)||{}),n=this.value;p.trim(n)||(n=null),t[e]=n,i.setFilterValue(r.id,t)},n={type:r.filter.range.type||"text"},l=!1;"date"===n.type&&(l=!0,n.type="text"),p.map(["min","max","step"],function(e){var t=r.filter.range[e];null!=t&&(n[e]=t,n.type="number")}),e=e||{};var a=v("input.form-control",p.extend({},n,{value:p.stringValue(e.min),placeholder:d.RANGE_FROM,onchange:function(){t.call(this,"min")},config:l?i.datePicker():m(500)})),o=v("input.form-control",p.extend({},n,{value:p.stringValue(e.max),placeholder:d.RANGE_TO,onchange:function(){t.call(this,"max")},config:l?i.datePicker():m(500)}));return v("div.range-filter",[v("div.input-wrapper.min",{key:"min"},a),v("div.input-wrapper.max",{key:"max"},o)])}(e,t,u):t.filter.text?(a=e,s=u,c=v("input.form-control",{type:(o=t).filter.text.type||"text",value:p.stringValue(s),placeholder:o.filter.placeholder||interpolate(gettext("Filter by %s"),[o.title]),onchange:function(){a.setFilterValue(o.id,this.value)},config:m(500)}),v("div.text-filter",c)):void 0}function t(r){var t=r.vm.data();if(null!==t){var e=p.extend(b(r),r.vm.filterValues());r.vm.filterValues(e);var n=p.map(t.columns,function(e,t){return function(e,t,n){var i=null,r={"":t.className},l=null;if(t.sortable){var a=e.vm.sort(),o=null;a==="+"+t.id&&(o="asc"),a==="-"+t.id&&(o="desc"),i=v("i.fa.fa-sort"+(o?"-"+o:"")),r.sortable=!0,o&&(r["sorted-"+o]=!0),l=function(){e.setSortColumn(t.id)}}var s={key:t.id,className:g(r),onclick:l};return(e.vm.data()?e.vm.data().massActions:null).length&&(0===n&&(s.className+=" hidden"),1===n&&(s.colspan=2)),v("th",s,[i," ",t.title])}(r,e,t)}),i=p.any(t.columns,p.property("filter"))?p.map(t.columns,function(e,t){return function(e,t,n){var i=null;t.filter&&(i=w(e,t));var r={key:t.id,className:t.className||""};return(e.vm.data()?e.vm.data().massActions:null).length&&(0===n&&(r.className+=" hidden"),1===n&&(r.colspan=2)),v("th",r,[i])}(r,e,t)}):null,l=v("thead",[v("tr.headers",n),i?v("tr.filters",i):null]),a=t.columns.length,o=v("td",{colspan:a},h(t.pagination,r.setPage)),s=v("tfoot",[v("tr",o)]),c=r.vm.data()?r.vm.data().massActions:null,u=!!r.vm.pickId(),d=p.map(t.items,function(i){var e={key:"item-"+i._id};return c.length&&(e.onclick=function(){r.saveCheck(i)},e.class=r.isChecked(i)?"active":""),v("tr",e,p.map(t.columns,function(e,t){var n;return n=0===t&&c.length?v("input[type=checkbox]",{value:i.type+"-"+i._id,class:"row-selection",onclick:p.boundPartial(r,r.saveCheck,i),checked:r.isChecked(i)}):i[e.id]||"",e.raw&&(n=v.trust(n)),e.linked&&(u?n=v("a",{href:"#",onclick:p.boundPartial(r,r.pickObject,i)},n):i._url&&(n=v("a",{href:i._url,onclick:x},n))),v("td",{key:"col-"+e.id,className:e.className||""},[n])}))}),m=v("tbody",d),f=c.length?".has-mass-actions":"";return v("table.table.table-striped.picotable-table"+f,[l,s,m])}}function x(e){e.stopPropagation()}function i(r){var l=r.vm.data();if(null!==l){var e=p.extend(b(r),r.vm.filterValues());r.vm.filterValues(e);var t,n,i,a=!!r.vm.pickId(),o=p.map(l.items,function(n){var e=null;n._abstract&&n._abstract.length&&(e=p.map(n._abstract,function(e){if(e&&("string"==typeof e&&(e={text:e}),e.text)){e.raw&&(e.text=v.trust(e.raw));var t="div.inner-row."+(e.title?"with-title":"")+(e.class?"."+e.class:"");return v(t,[e.title?v("div.column.title",e.title):null,v("div.column",e.text)])}}),p.any(e,function(e){return!!e})||(e=null)),null===e&&(e=p.map(l.columns,function(e){var t=n[e.id]||"";return e.raw&&(t=v.trust(t)),v("div.inner-row.with-title",[v("div.column.title",e.title),v("div.column",t)])}));var t={href:n._url};a&&(t.onclick=p.boundPartial(r,r.pickObject,n),t.href="#");var i=n._linked_in_mobile?v("a.inner",t,e):v("span.inner",e);return v("div.list-element",i)});return v("div.mobile",[v("div.row.mobile-header",[v("div.col-sm-6",[v("button.btn.btn-info.btn-block.toggle-btn",{onclick:function(){r.vm.showMobileFilterSettings(!0)}},[v("i.fa.fa-filter")],"Show filters")]),v("div.col-sm-6",[v("div.mobile-sort",function(t){var e=t.vm.data(),n=[];if(p.map(e.columns,function(e){e.sortable&&(n.push({value:"+"+e.id,text:d.SORT_BY+" "+e.title+" "+d.SORT_ASC}),n.push({value:"-"+e.id,text:d.SORT_BY+" "+e.title+" "+d.SORT_DESC}))}),n.length)return n.unshift({value:"",text:d.SORT_DEFAULT}),v("select.picotable-mobile-sort.form-control",{id:"mobile-sort-select",value:t.vm.sort()||"",onchange:v.withAttr("value",function(e){t.setSortColumn(e),t.refresh()})},p.map(n,function(e){return v("option",{value:e.value},e.text)}))}(r))])]),r.vm.showMobileFilterSettings()?(t=r,n=t.vm.data(),i=p.map(n.columns,function(e){return e.filter?v("div.single-filter",v("h3",e.title),w(t,e)):null}),v("div.mobile-filters.shuup-modal-bg",{key:"mobileFilterModal"},[v("div.shuup-modal-container",[v("div.shuup-modal-header",[v("h2.pull-left",[v("i.fa.fa-filter")],gettext("Filters")),v("button.btn.btn-success.pull-right",{onclick:function(){t.vm.showMobileFilterSettings(!1)}},"Done"),v("button.btn.btn-gray.btn-inverse.pull-right",{onclick:t.resetFilters,disabled:p.isEmpty(t.vm.filterValues())},d.RESET)]),v("div.mobile-filters-content",i)])])):null,v("hr"),v("div.mobile-items",o),h(l.pagination,r.setPage)])}}function r(t){var e=t.vm.data()?t.vm.data().itemInfo:null;return v("div.picotable-header",[function(t){var e=t.vm.data()?t.vm.data().massActions:null,n=!!t.vm.pickId();if(null===e||n)return"";var i=t.vm.data().pagination.nItems;if(0===i)return"";var r=t.vm.data().items.length;return e=[{key:0,value:gettext("Select Action")},{key:"unselect_all",value:gettext("Clear Selections")},{key:"select_all",value:gettext("Select All")},{key:"select_listed",value:interpolate(gettext("Select All %s Items"),[r])}].concat(e),v("div.picotable-mass-actions",[t.vm.allItemsSelected()?v("p",interpolate(gettext("All %s Items Selected"),[i])):null,v("select.picotable-mass-action-select.form-control",{id:"mass-action-select"+t.id,config:function(e,t){t||$(e).select2()},value:0,onchange:v.withAttr("value",function(e){t.doMassAction(e)})},p.map(e,function(n){var i=["key","value"],r={value:n.key};return Object.keys(n).forEach(function(e){if(!i.includes(i)){var t=e.replace("_","-");r["data-"+t]=n[e]}}),v("option",r,n.value)}))])}(t),v("div.picotable-items-per-page-ctr",[v("select.picotable-items-per-page-select.form-control",{id:"pipps"+t.id,value:t.vm.perPage(),onchange:v.withAttr("value",function(e){t.vm.perPage(e),t.refresh()})},p.map(t.vm.perPageChoices(),function(e){return v("option",{value:e},e+" / "+d.PAGE)}))]),v("div.picotable-item-info",e),v("div.picotable-reset-filters-ctr",v("button.picotable-reset-filters-btn.btn.btn-gray.btn-inverse",{onclick:t.resetFilters,disabled:p.isEmpty(t.vm.filterValues())},d.RESET_FILTERS))])}function l(e){return v("div.table-view",[e.vm.showHeader()?r(e):null,"mobile"===e.vm.renderMode()?i(e):t(e)])}function a(){var c=this;c.id="0"|134217727*Math.random(),c.vm={url:v.prop(null),sort:v.prop(null),filterEnabled:v.prop({}),filterValues:v.prop({}),checkboxes:v.prop([]),allItemsSelected:v.prop(!1),page:v.prop(1),perPage:v.prop(20),perPageChoices:v.prop([20,50,100,200]),showHeader:v.prop(!0),data:v.prop(null),renderMode:v.prop("normal"),showMobileFilterSettings:v.prop(!1),pickId:v.prop(null)},c.setRenderMode=function(e){var t=c.vm.renderMode();c.vm.renderMode(e),e!==t&&c.refresh()},c.adaptRenderMode=function(){var e=window.innerWidth;c.setRenderMode(e<992?"mobile":"normal")},c.setSource=function(e){c.vm.url(e),c.refresh()},c.setSortColumn=function(e){var t=null;if(e&&e.length&&"null"!==e)if(/^[+-]/.test(e))t=e;else{var n=c.vm.sort();t=n==="+"+e?"-"+e:n==="-"+e?null:"+"+e}c.vm.sort(t),c.refresh()},c.getFilterValue=function(e){return c.vm.filterValues()[e]},c.setFilterValue=function(e,t){var n=c.vm.filterValues();"string"==typeof t&&""===p.trim(t)&&(t=null),n[e]=t,n=p.omitNulls(n),c.vm.filterValues(n),c.refresh()},c.resetFilters=function(){c.vm.filterValues({}),c.refresh()},c.resetCheckboxes=function(){c.vm.allItemsSelected(!1),c.vm.checkboxes([])},c.saveCheck=function(t){var e=c.vm.checkboxes(),n=e.filter(function(e){return e!==t._id});n.length<e.length?c.vm.checkboxes(n):(e.push(t._id),c.vm.checkboxes(e)),$(t).toggleClass("active")},c.isChecked=function(t){return 0<c.vm.checkboxes().filter(function(e){return e===t._id}).length},c.getMassActionResponse=function(e){if(200===e.status){var t="",n=e.getResponseHeader("Content-Disposition");if(n&&-1!==n.indexOf("attachment")){var i=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(n);null!==i&&i[1]&&(t=i[1].replace(/['"]/g,""))}var r=e.getResponseHeader("Content-Type"),l=new Blob([e.response],{type:r});if(void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(l,t);else{var a=window.URL||window.webkitURL,o=a.createObjectURL(l);if(t){var s=document.createElement("a");void 0===s.download?window.location=o:(s.href=o,s.download=t,document.body.appendChild(s),s.click())}else{$("option[value="+window.savedValue+"]").data("redirects")&&(window.location=$("option[value="+window.savedValue+"]").data("redirect-url")),c.resetCheckboxes(),$(".picotable-mass-action-select").val(0),c.refresh(),setTimeout(function(){window.Messages.enqueue({tags:"success",text:gettext("Mass Action complete.")})},1e3)}setTimeout(function(){a.revokeObjectURL(o)},100)}}else c.resetCheckboxes(),$(".picotable-mass-action-select").val(0),c.refresh(),setTimeout(function(){window.Messages.enqueue({tags:"error",text:gettext("Something went wrong.")})},1e3)},c.doMassAction=function(e){switch(e){case"select_all":return void c.selectAllProducts();case"select_listed":return void c.selectAllListedProducts();case"unselect_all":return void c.resetCheckboxes()}var t=c.vm.checkboxes();if(window.savedValue=e,0!==t.length){if(0!==e){if(!confirm(gettext("Confirm action by clicking OK!")))return $(".picotable-mass-action-select").val(0),void c.refresh();var n={action:e,values:c.vm.allItemsSelected()?"all":t},i=$("option[value="+e+"]").data("callback");i&&window[i]?window[i](n.values):v.request({method:"POST",url:window.location.pathname,data:n,extract:c.getMassActionResponse,config:function(e){e.setRequestHeader("X-CSRFToken",window.ShuupAdminConfig.csrf),e.setRequestHeader("Content-type","application/json"),e.responseType="blob"}})}}else alert(gettext("You haven't selected anything"))},c.selectAllListedProducts=function(){c.vm.allItemsSelected(!1),c.vm.checkboxes(c.vm.data().items.map(function(e){return e._id}))},c.selectAllProducts=function(){c.selectAllListedProducts(),c.vm.allItemsSelected(!0)},c.setPage=function(e){e|=0,(isNaN(e)||e<1)&&(e=1),c.vm.page(e),c.refresh()},c.refresh=function(){var e=c.vm.url();if(e){var t={sort:c.vm.sort(),perPage:0|c.vm.perPage(),page:0|c.vm.page(),filters:c.vm.filterValues()},n=v.route.parseQueryString(decodeURI(location.search));n.jq=JSON.stringify(t),v.request({method:"GET",url:e,data:n}).then(c.vm.data,function(){alert("An error occurred.")}),c.saveSettings()}},c.saveSettings=function(){n&&n.setItem("picotablePerPage",c.vm.perPage())},c.loadSettings=function(){if(n){var e=0|n.getItem("picotablePerPage");1<e&&c.vm.perPage(e);var t=/pick=([^&]+)/.exec(location.search);c.vm.pickId(t?t[1]:null)}},c.pickObject=function(t){var e=window.opener;if(e){var n=null;p.map(["_text","_name","title","name","text"],function(e){!n&&t[e]&&(n=t[e])}),!n&&t._abstract&&0<t._abstract.length&&(n=t._abstract[0]).text&&(n=n.text),n||(n="#"+t._id),e.postMessage({pick:{id:c.vm.pickId(),object:{id:t._id,text:n,url:t._url}}},"*"),event.preventDefault()}else alert("Window has no opener. Can't pick object.")},c.datePicker=function(){return function(e,t){t||$(e).datetimepicker({format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,todayHighlight:!0,fontAwesome:!0,minView:2})}},c.loadSettings(),c.adaptRenderMode(),window.addEventListener("resize",p.debounce(c.adaptRenderMode,100)),v.deferred.onerror=function(e){if(!e.toString().match(/^SyntaxError/)&&"[object Error]"==={}.toString.call(e)&&!e.constructor.toString().match(/ Error/))throw e}}var e=function(e,t){this.ctrl=v.mount(e,{view:l,controller:a}),this.ctrl.setSource(t)};return e.lang=d,e}(window.m,window.localStorage);"undefined"!=typeof module&&null!==module&&module.exports?module.exports=Picotable:"function"==typeof define&&define.amd&&define(function(){return Picotable});
//# sourceMappingURL=picotable.js.map
