
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tutorials &#8212; qmpy 1.1.0a documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.1.0a',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Data models" href="models.html" />
    <link rel="prev" title="Installation" href="getting_started.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="models.html" title="Data models"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">qmpy 1.1.0a documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-qmpy">
<span id="tutorials"></span><h1>Tutorials<a class="headerlink" href="#module-qmpy" title="Permalink to this headline">¶</a></h1>
<p>qmpy is a package containing many tools for computational materials science.</p>
<p>The qmpy package comes bundled with two executable scripts, <cite>qmpy</cite> and <cite>oqmd</cite>.
<cite>qmpy</cite> is a simple bash script that starts an interactive python
environment and imports qmpy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ qmpy
&gt;&gt;&gt;
</pre></div>
</div>
<p>To write your own python script that utilizes qmpy functionality, simply start
with an import like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qmpy</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>and all of the commands shown below should work.</p>
<div class="section" id="database-entries">
<h2>Database entries<a class="headerlink" href="#database-entries" title="Permalink to this headline">¶</a></h2>
<p>Once the database is <a class="reference external" href="getting_started">installed</a>, you can query it very
flexibly and easily. In this section we will explore the data structure of
entries in the OQMD and provide several examples of how to make queries.
For deeper understanding of how django models work, you should check out the
(excellent) <a class="reference external" href="http://docs.djangoproject.com/en/1.6/">django documentation</a>.</p>
<p>First, lets look at how to access an entry from the database. As an example,
lets pull up an entry for an <a class="reference internal" href="materials.html#qmpy.Element" title="qmpy.Element"><code class="xref py py-mod docutils literal"><span class="pre">Element</span></code></a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;Fe&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span>
<span class="go">&lt;Element: Fe&gt;</span>
</pre></div>
</div>
<p>Django models have a number of fields that can be accessed directly once the
database entry has been loaded. For example, with an element you can:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span><span class="o">.</span><span class="n">symbol</span>
<span class="go">u&#39;Fe&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span><span class="o">.</span><span class="n">z</span>
<span class="go">26L</span>
</pre></div>
</div>
<p>For a complete list of the model attributes that are stored in the database,
refer to the documentation for the model you are interested in, in this case
<a class="reference internal" href="materials.html#qmpy.Element" title="qmpy.Element"><code class="xref py py-mod docutils literal"><span class="pre">Element</span></code></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When strings are returned, they are returned as unicode strings,
(indicated by the “u” preceding the string) integers are
returned as long integers (indicated by the trailing “L”). For most
purposes this makes no difference, as these data types will generally
behave exactly as expected, i.e.:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="mi">26</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s2">&quot;Fe&quot;</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
<p>In addition to data attributes like these, django models have relationships to
other models. In qmpy there are two flavors of relationships: one-to-many and
many-to-many. An example of a one-to-many relationship would be the
relationship between an <a class="reference internal" href="materials.html#qmpy.Element" title="qmpy.Element"><code class="xref py py-mod docutils literal"><span class="pre">Element</span></code></a> and an <a class="reference internal" href="materials.html#qmpy.Atom" title="qmpy.Atom"><code class="xref py py-mod docutils literal"><span class="pre">Atom</span></code></a>.
There are many atoms which are a given element, but each atom is only
one element. In the case of Fe:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span><span class="o">.</span><span class="n">atom_set</span>
<span class="go">&lt;django.db.models.fields.related.RelatedManager object at 0x7f0997fa2690&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span><span class="o">.</span><span class="n">atom_set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">127585</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">atom</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">atom_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">atom</span>
<span class="go">&lt;Atom: Fe @ 0.000000 0.000000 0.000000&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">atom</span><span class="o">.</span><span class="n">element</span>
<span class="go">&lt;Element: Fe&gt;</span>
</pre></div>
</div>
<p>A <code class="xref py py-class docutils literal"><span class="pre">RelatedManager</span></code> is an object that deals with obtaining other django models
that are related to the main object. We can use the objects.count() method to
fidn the number of <a class="reference internal" href="materials.html#qmpy.Atom" title="qmpy.Atom"><code class="xref py py-mod docutils literal"><span class="pre">Atom</span></code></a> objects that are Fe, and find ~125,000.
To obtain one of these atoms, we use the objects.first() method, which
simply returns the first <a class="reference internal" href="materials.html#qmpy.Atom" title="qmpy.Atom"><code class="xref py py-mod docutils literal"><span class="pre">Atom</span></code></a> which is Fe. Much more functionality of Managers
and RelatedManagers will be shown throughout this tutorial and in the examples,
but for a proper understanding you should refer to the django docs.</p>
<p>An example of a many-to-many relationship would be the relationship between an
<a class="reference internal" href="materials.html#qmpy.Element" title="qmpy.Element"><code class="xref py py-mod docutils literal"><span class="pre">Element</span></code></a> and a <a class="reference internal" href="materials.html#qmpy.Composition" title="qmpy.Composition"><code class="xref py py-mod docutils literal"><span class="pre">Composition</span></code></a>. A composition (e.g. Fe2O3)
can contain many elements (Fe and O), and an element can be a part of many
compositions (Fe3O4 and FeO as well). This is the nature of a many-to-many
relationship. In the case of Fe:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fe</span><span class="o">.</span><span class="n">composition_set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">10882</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comp</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">composition_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ntypes</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comp</span>
<span class="go">&lt;Composition: AcFe&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comp</span><span class="o">.</span><span class="n">element_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;Element: Ac&gt;, &lt;Element: Fe&gt;]</span>
</pre></div>
</div>
<p>In this example we have taken our base object (the <a class="reference internal" href="materials.html#qmpy.Element" title="qmpy.Element"><code class="xref py py-mod docutils literal"><span class="pre">Element</span></code></a>) and filtered its
composition_set for <a class="reference internal" href="materials.html#qmpy.Composition" title="qmpy.Composition"><code class="xref py py-mod docutils literal"><span class="pre">Composition</span></code></a> objects which meet the condition ntypes=2 (i.e.
there are two elements in the composition), and taken the first such
<a class="reference internal" href="materials.html#qmpy.Composition" title="qmpy.Composition"><code class="xref py py-class docutils literal"><span class="pre">Composition</span></code></a> (index 0 in the <code class="xref py py-class docutils literal"><span class="pre">QuerySet</span></code> that is returned).</p>
</div>
<div class="section" id="creating-a-structure">
<h2>Creating a structure<a class="headerlink" href="#creating-a-structure" title="Permalink to this headline">¶</a></h2>
<p>There are several ways to create a structure, but we will start with reading in
a POSCAR:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">INSTALL_PATH</span><span class="o">+</span><span class="s1">&#39;/io/files/POSCAR_BCC&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you have the <a class="reference internal" href="materials.html#qmpy.Structure" title="qmpy.Structure"><code class="xref py py-mod docutils literal"><span class="pre">Structure</span></code></a> object, the important features of a crystal
structure can be accessed readily.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">cell</span>
<span class="go">array([[ 3.,  0.,  0.],</span>
<span class="go">       [ 0.,  3.,  0.],</span>
<span class="go">       [ 0.,  0.,  3.]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">lat_params</span>
<span class="go">[3.0, 3.0, 3.0, 90.0, 90.0, 90.0]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">atoms</span>
<span class="go">[&lt;Atom: Cu @ 0.000000 0.000000 0.000000&gt;, &lt;Atom: Cu @ 0.500000 0.500000</span>
<span class="go">0.500000&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">composition</span>
<span class="go">&lt;Composition: Cu&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">volume</span>
<span class="go">27.0</span>
</pre></div>
</div>
<p>You can also readily construct a <a class="reference internal" href="materials.html#qmpy.Structure" title="qmpy.Structure"><code class="xref py py-mod docutils literal"><span class="pre">Structure</span></code></a> from scratch, from the lattice
vectors and the atom positions.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">create</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">[(</span><span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span>
<span class="go">                                    (&#39;Cu&#39;, [0.5,0.5,0.5])])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">==</span> <span class="n">s</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
<div class="section" id="first-principles-calculations">
<h2>First Principles Calculations<a class="headerlink" href="#first-principles-calculations" title="Permalink to this headline">¶</a></h2>
<p>At this time qmpy only supports automation of calculations using the Vienna Ab
Initio Simulation Package (VASP). The reading and creation of these
calculations are handled by the <a class="reference internal" href="calculations.html#qmpy.Calculation" title="qmpy.Calculation"><code class="xref py py-mod docutils literal"><span class="pre">Calculation</span></code></a> model.
To read in an existing calculation:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/analysis/vasp/files/normal/fine_relax/&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span> <span class="o">=</span> <span class="n">Calculation</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">INSTALL_PATH</span><span class="o">+</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>qmpy will search the directory for an OUTCAR or OUTCAR.gz file. If it is able
to find an OUTCAR, it will attempt to read the file. Next, we will demonstrate
several of the key attributes you may wish to access:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span><span class="o">.</span><span class="n">energy</span> <span class="c1"># the final total energy</span>
<span class="go">-12.416926999999999</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span><span class="o">.</span><span class="n">energies</span> <span class="c1"># the total energies of each step</span>
<span class="go">array([-12.415236 -12.416596, -12.416927])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span><span class="o">.</span><span class="n">volume</span> <span class="c1"># the output volume</span>
<span class="go">77.787375068172508</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span><span class="o">.</span><span class="n">input</span>
<span class="go">&lt;Structure: SrGe2&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span><span class="o">.</span><span class="n">output</span>
<span class="go">&lt;Structure: SrGe2&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
<span class="go">{&#39;algo&#39;: &#39;fast&#39;,</span>
<span class="go"> &#39;ediff&#39;: 0.0001,</span>
<span class="go"> &#39;encut&#39;: 373.0,</span>
<span class="go"> &#39;epsilon&#39;: 1.0,</span>
<span class="go"> &#39;ibrion&#39;: 1,</span>
<span class="go"> &#39;idipol&#39;: 0,</span>
<span class="go"> &#39;isif&#39;: 3,</span>
<span class="go"> &#39;ismear&#39;: 1,</span>
<span class="go"> &#39;ispin&#39;: 1,</span>
<span class="go"> &#39;istart&#39;: 0,</span>
<span class="go"> &#39;lcharg&#39;: True,</span>
<span class="go"> &#39;ldipol&#39;: False,</span>
<span class="go"> &#39;lorbit&#39;: 0,</span>
<span class="go"> &#39;lreal&#39;: False,</span>
<span class="go"> &#39;lvtot&#39;: False,</span>
<span class="go"> &#39;lwave&#39;: False,</span>
<span class="go"> &#39;nbands&#39;: 24,</span>
<span class="go"> &#39;nelm&#39;: 60,</span>
<span class="go"> &#39;nelmin&#39;: 5,</span>
<span class="go"> &#39;nsw&#39;: 40,</span>
<span class="go"> &#39;potentials&#39;: [{&#39;name&#39;: &#39;Ge_d&#39;, &#39;paw&#39;: True, &#39;us&#39;: False, &#39;xc&#39;: &#39;PBE&#39;},</span>
<span class="go">                {&#39;name&#39;: &#39;Sr_sv&#39;, &#39;paw&#39;: True, &#39;us&#39;: False, &#39;xc&#39;: &#39;PBE&#39;}],</span>
<span class="go"> &#39;potim&#39;: 0.5,</span>
<span class="go"> &#39;prec&#39;: &#39;med&#39;,</span>
<span class="go"> &#39;pstress&#39;: 0.0,</span>
<span class="go"> &#39;sigma&#39;: 0.2}</span>
</pre></div>
</div>
</div>
<div class="section" id="searching-for-models">
<h2>Searching for models<a class="headerlink" href="#searching-for-models" title="Permalink to this headline">¶</a></h2>
<p>The documentation for Django for searching for models is ver complete, and
should be taken as the ultimate reference for searching for models in qmpy, but
a basic overview is provided here. Specific methods used in this section are
the ‘filter’, ‘exclude’ and ‘get’ methods.</p>
<p>Searches using filter will, as the name suggests, filter for database entries
that have the specified properties. Similarly, exclude will return entries that
do NOT have the specified properties. Both of these methods will return a
QuerySet containing any objects that meet the requirements of your search.
Filter and exclude calls can be chained together to create relatively complex
queries. Get is slightly different in that it returns ONLY ONE object, and
returns the object itself, rather than a QuerySet of such objects.</p>
<p>A much more complete documentation of all things query related can be found at
the <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/db/queries/">django docs</a></p>
<div class="section" id="searching-for-entries-based-on-stability">
<h3>Searching for entries based on stability<a class="headerlink" href="#searching-for-entries-based-on-stability" title="Permalink to this headline">¶</a></h3>
<p>Formation energies are stored as FormationEnergy instances, which are
associated with an <cite>:mod:~qmpy.Entry</cite> and a <cite>:mod:~qmpy.Calculation</cite>. Knowing
this, we can search for stable Entries using:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stable</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">formationenergy__stability__lt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stable</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">18150</span>
</pre></div>
</div>
<p>The same concept can be applied to searching for other quantities, as long as
you can relate them to a FormationEnergy by “__” constructions:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stable_comps</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">formationenergy__stability__lt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stable_comps</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">18150</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">calculated__formationenergy__stability__lt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">18150</span>
</pre></div>
</div>
<p>Adding other search criteria lets you explore a little more:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stable</span> <span class="o">=</span> <span class="n">FormationEnergy</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stability__lt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Find the number of stable compounds containing O</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stable</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">composition__element_set</span><span class="o">=</span><span class="s1">&#39;O&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">4017</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># or Fe. Is it surprising that this is smaller?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stable</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">composition__element_set</span><span class="o">=</span><span class="s1">&#39;Fe&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">653</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Meta data is also a possiblity. How many stable compounds were found</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># in the course of calculations for a particular project?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stable</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">entry__project_set</span><span class="o">=</span><span class="s1">&#39;prototypes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">3119</span>
</pre></div>
</div>
</div>
<div class="section" id="searching-for-entries-based-on-composition">
<h3>Searching for entries based on composition<a class="headerlink" href="#searching-for-entries-based-on-composition" title="Permalink to this headline">¶</a></h3>
<p>You can find compositions in a few ways using filters and excludes. If you want
a specific region of phase space (including related subspaces):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">elts</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span> <span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">others</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">symbol__in</span><span class="o">=</span><span class="n">elts</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comps</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">element_set</span><span class="o">=</span><span class="n">others</span><span class="p">)</span>
</pre></div>
</div>
<p>This searchs finds every composition that doesn’t have any elements that aren’t
in the region of phase space requested. For binary or ternary phase spaces it
can be more efficient to search permutations of sub-spaces:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">comps</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ntypes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elts</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">comps</span> <span class="o">=</span> <span class="n">comps</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">element_set</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elts</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">e_comps</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">element_set</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">ntypes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">comps</span> <span class="o">|=</span> <span class="n">e_comps</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">elts</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">bin_comps</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">element_set</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">bin_comps</span> <span class="o">=</span> <span class="n">bin_comps</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">element_set</span><span class="o">=</span><span class="n">e2</span><span class="p">,</span> <span class="n">ntypes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">comps</span> <span class="o">|=</span> <span class="n">bin_comps</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comps</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<p>However, for larger regions of phase space (4 or 5 or more) the number of
subqueries of the second approach rapidly becomes more expensive than the
single, more complicated query of the first.</p>
</div>
</div>
<div class="section" id="advanced-searching">
<h2>Advanced searching<a class="headerlink" href="#advanced-searching" title="Permalink to this headline">¶</a></h2>
<p>The previous section covered some pretty basic methods for searching for
database entries. In this section we will look at some more advanced concepts,
specifically: aggregation, Q() and F().</p>
<div class="section" id="aggregation-and-annotation">
<h3>Aggregation and Annotation<a class="headerlink" href="#aggregation-and-annotation" title="Permalink to this headline">¶</a></h3>
<p>Django also provides methods for adding searchable and retrievable fields to
database entries within the SQL command. For example, suppose we want to search
for <a class="reference internal" href="materials.html#qmpy.Entry" title="qmpy.Entry"><code class="xref py py-mod docutils literal"><span class="pre">Entry</span></code></a> objects that have more than 5 structures associated with
them. We can accomplish this using aggregation to add a temporary field to
Entries that is the number of structures. This temporary field can then be
filtered on and returned just like a normal field:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Average</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entries</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_structures</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">many_structs</span> <span class="o">=</span> <span class="n">entries</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">n_structures__gt</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">many_structs</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;n_structures&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">{&#39;id&#39;: 1562L,</span>
<span class="go"> &#39;n_structures&#39;: 6,</span>
<span class="go"> &#39;path&#39;: u&#39;/home/oqmd/libraries/prototypes/elements/C19/Ne&#39;}</span>
</pre></div>
</div>
<p>We can also do a variety of aggregation methods, also in SQL. Say we want to
know the average number of elements (averaged over all compositions in the
OQMD, or over ICSD structures):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s1">&#39;ntypes&#39;</span><span class="p">))</span>
<span class="go">{&#39;ntypes__avg&#39;: 2.9965}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">entry__meta_data__value</span><span class="o">=</span><span class="s1">&#39;icsd&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="go">            aggregate(Avg(&#39;ntypes&#39;))</span>
<span class="go">{&#39;ntypes__avg&#39;: 2.9811}</span>
</pre></div>
</div>
</div>
<div class="section" id="complex-searches">
<h3>Complex searches<a class="headerlink" href="#complex-searches" title="Permalink to this headline">¶</a></h3>
<p>When using sequential filter and exclude commands, these commands are related
by AND operators. In order to execute more complicated queries which use a
series of AND and OR operators, we must use the Q() method.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">meta_data__value</span><span class="o">=</span><span class="s1">&#39;prototype&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">meta_data__value</span><span class="o">=</span><span class="s1">&#39;icsd&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<p>The Q() query method also supports negation, by calling ~Q():</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Composition</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">ntypes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span>
<span class="go">                               ~Q(element_set=&#39;O&#39;))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-qmpy-to-manage-a-high-throughput-calculation-project">
<h2>Using qmpy to manage a high-throughput calculation project<a class="headerlink" href="#using-qmpy-to-manage-a-high-throughput-calculation-project" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#module-qmpy" title="qmpy"><code class="xref py py-mod docutils literal"><span class="pre">qmpy</span></code></a> can manage almost every aspect of a high-throughput materials screening
project. In this section we will walk through all of the necessary steps to
get a new project off the ground in a new installation. This tutorial assumes
that you have a functional installation of <a class="reference internal" href="#module-qmpy" title="qmpy"><code class="xref py py-mod docutils literal"><span class="pre">qmpy</span></code></a>, as well as a working
database (does not need to have a copy of the OQMD included, a blank slate
database will work fine).</p>
<p>In this tutorial we will undertake to explore a wide range of (CH3NH3)PbI3
perovskites, which have recently recieved much attention as high-efficiency
photovoltaic cells. We will run through the process of setting up compute
resources, constructing simple lattice decorations of this structure, as well
as some not-so-simple decorations, running the calculations, and finally
evaluating the relative stability of the resulting energies.</p>
<div class="section" id="setting-up-computational-resources">
<h3>Setting up computational resources<a class="headerlink" href="#setting-up-computational-resources" title="Permalink to this headline">¶</a></h3>
<p>We will begin with configuring qmpy to find the right computational resources
to be able to perform calculations using qmpy. First, you need to establish the
computational resources that are available to it: a <a class="reference internal" href="resources.html#qmpy.Account" title="qmpy.Account"><code class="xref py py-mod docutils literal"><span class="pre">Account</span></code></a>, which is a
<a class="reference internal" href="resources.html#qmpy.Host" title="qmpy.Host"><code class="xref py py-mod docutils literal"><span class="pre">Host</span></code></a> paired with a <a class="reference internal" href="resources.html#qmpy.User" title="qmpy.User"><code class="xref py py-mod docutils literal"><span class="pre">User</span></code></a>. A <a class="reference internal" href="resources.html#qmpy.Account" title="qmpy.Account"><code class="xref py py-mod docutils literal"><span class="pre">Account</span></code></a> is then granted
access to at least one <a class="reference internal" href="resources.html#qmpy.Allocation" title="qmpy.Allocation"><code class="xref py py-mod docutils literal"><span class="pre">Allocation</span></code></a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In the current implementation, qmpy is only able to run calculations on
clusters that utilize PBS/torque and Maui.</p>
</div>
<p>Lets start by configuring a host. Lets assume that we are running qmpy from one
cluster, but we want to do our calculations on another machine. Lets edit the
resources/hosts.yml file (inside the qmpy installation):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># hosts.yml</span>
<span class="n">bigcluster</span><span class="p">:</span>
  <span class="n">binaries</span><span class="p">:</span> <span class="p">{</span><span class="n">vasp_53</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">vasp_53</span><span class="p">}</span>
  <span class="n">check_queue</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">maui</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">showq</span>
  <span class="n">hostname</span><span class="p">:</span> <span class="n">big</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">edu</span>
  <span class="n">ip_address</span><span class="p">:</span> <span class="n">XXX</span><span class="o">.</span><span class="n">XX</span><span class="o">.</span><span class="n">XX</span><span class="o">.</span><span class="n">XXX</span>
  <span class="n">nodes</span><span class="p">:</span> <span class="mi">100</span>
  <span class="n">ppn</span><span class="p">:</span> <span class="mi">12</span>
  <span class="n">sub_script</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">qsub</span>
  <span class="n">sub_text</span><span class="p">:</span> <span class="n">bigcluster</span><span class="o">.</span><span class="n">q</span>
  <span class="n">walltime</span><span class="p">:</span> <span class="mi">691200</span>
</pre></div>
</div>
<p>In this configuration file, we are creating a list of dictionaries. Each outer
loop entry creates a <a class="reference internal" href="resources.html#qmpy.Host" title="qmpy.Host"><code class="xref py py-mod docutils literal"><span class="pre">Host</span></code></a>.</p>
<p>Important attributes to be aware of:</p>
<ul class="simple">
<li>binaries is a dictionary of binary name -&gt; binary path pairs. By default,
qmpy calculations try to run vasp_53, and expects a path to a vasp 5.3.3
binary, but should be reliable for most vasp 5.X versions.</li>
<li>sub_script is the path on the cluster to pbs qsub command</li>
<li>check_queue is the path on the cluster to maui’s showq command</li>
<li>sub_text is the name of a file in qmpy/configuration/qfiles. An example qfile
template is shown below.</li>
<li>ppn = # of processors / node</li>
<li>nodes = # of nodes you want qmpy to be able to use (does not need to match
the number of nodes on the cluster)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that these files must be parseable YAML format files. See <cite>this guide
&lt;http://www.yaml.org/start.html&gt; _</cite> for an introduction to the YAML format.</p>
</div>
<p>The queue files that qmpy submits must be tailored both to the job being
submitted and the cluster being submitted to. To that end, qmpy uses a simple
template system, with the most basic template (that should work in many cases)
is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
#MSUB -l nodes={nodes}:ppn={ppn}
#MSUB -l walltime={walltime}
#MSUB -N {name}
#MSUB -o jobout.txt
#MSUB -e joberr.txt
#MSUB -A {key}

cd $PBS_O_WORKDIR
NPROCS=`wc -l &lt; $PBS_NODEFILE`
#running on {host}

{header}

{mpi} {binary} {pipes}

{footer}
</pre></div>
</div>
<p>The “{variable}” construction is used to automatically replace strings based on
the calculation requirements. Some variables (nodes, ppn, name, walltime, host)
are fairly constant for the host. Others, like “key”, specify which allocation
to charge the hours to, which is defined by the <a class="reference internal" href="resources.html#qmpy.Allocation" title="qmpy.Allocation"><code class="xref py py-mod docutils literal"><span class="pre">Allocation</span></code></a>
associated with the calculation. Finally, the rest of the variables are set
based on the requirements of the calculation. For general calculations, the
header variable is used to unzip any zipped files in the folder (e.g., CHGCAR),
the for parallel calculations the mpi variable contains the mpirun + argumnts
command and for serial calculations it is left blank. The binary variable will
be replaced with the path to the binary, as defined in the hosts.yml file. The
pipes variable will pipe stdout and stderr, which by default is always to
stdout.txt and stderr.txt. Finally, footer zips the CHGCAR, OUTCAR, PROCAR and
ELFCAR, if they exist.</p>
<p>and resources/hosts.yml:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># users.yml</span>
<span class="n">oqmdrunner</span><span class="p">:</span>
  <span class="n">bigcluster</span><span class="p">:</span> <span class="p">{</span><span class="n">run_path</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">oqmdrunner</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">oqmdrunner</span><span class="p">}</span>

<span class="n">oqmduser</span><span class="p">:</span>
  <span class="n">bigcluster</span><span class="p">:</span> <span class="p">{</span><span class="n">run_path</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">oqmduser</span><span class="o">/</span><span class="n">rundir</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">oqmduser</span><span class="p">}</span>
  <span class="n">smallcluster</span><span class="p">:</span> <span class="p">{</span><span class="n">run_path</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">oqmduser</span><span class="o">/</span><span class="n">rundir</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">oqmduser</span><span class="p">}</span>
</pre></div>
</div>
<p>loop entry creates a <a class="reference internal" href="resources.html#qmpy.User" title="qmpy.User"><code class="xref py py-mod docutils literal"><span class="pre">User</span></code></a> with that name, and each cluster listed
then creates an <a class="reference internal" href="resources.html#qmpy.Account" title="qmpy.Account"><code class="xref py py-mod docutils literal"><span class="pre">Account</span></code></a> for that <a class="reference internal" href="resources.html#qmpy.User" title="qmpy.User"><code class="xref py py-mod docutils literal"><span class="pre">User</span></code></a>, with username
(given by username) and configured to run calculations in run_path. Here we are
assuming that a second non-compute cluster, smallcluster, was also defined in
hosts.yml.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Passwordless ssh must be configured to each account (either as a user:host
pair, or host-based authentication) from the account you are running qmpy
on. The <a class="reference internal" href="resources.html#qmpy.Account" title="qmpy.Account"><code class="xref py py-mod docutils literal"><span class="pre">Account</span></code></a> class has a create_passwordless_ssh method
that can set this up for you, however, this process can be unreliable, so if
it fails you will need to sort those problems out for yourself.</p>
</div>
<p>Next, we configure our allocations, using the allocations.yml file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># allocations.yml</span>
<span class="n">bigcluster</span><span class="p">:</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">bigcluster</span>
  <span class="n">users</span><span class="p">:</span> <span class="p">[</span><span class="n">oqmdrunner</span><span class="p">,</span> <span class="n">oqmduser</span><span class="p">]</span>
  <span class="n">key</span><span class="p">:</span> <span class="n">alloc1234</span>
</pre></div>
</div>
<p>An allocation takes a host, a list of users and an optional key. The host and
list of users are used to determine who is allowed to run calculations on the
allocation, while the key is used to identify the allocation to moab, if that
feature is implemented.</p>
<p>Finally, we can create a <a class="reference internal" href="resources.html#qmpy.Project" title="qmpy.Project"><code class="xref py py-mod docutils literal"><span class="pre">Project</span></code></a>, defined in projects.yml:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># projects.yml</span>
<span class="n">example</span><span class="p">:</span>
  <span class="n">allocations</span><span class="p">:</span> <span class="p">[</span><span class="n">bigcluster</span><span class="p">]</span>
  <span class="n">priority</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">users</span><span class="p">:</span> <span class="p">[</span><span class="n">oqmdrunner</span><span class="p">]</span>
</pre></div>
</div>
<p>We title the project “example”, (since it is just an example) and then
define the lists of allocations that this project is authorized to use, and the
users that are associated with the project. In order to apply these changes,
run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">qmpy</span> <span class="k">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sync_resources</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="working-with-structures">
<h3>Working with Structures<a class="headerlink" href="#working-with-structures" title="Permalink to this headline">¶</a></h3>
<p>If, for example, we say that we want to calculate i) a range of defects in a
host matrix or ii) a wide range of compositions in a particular structure. It
is possible to do this in the framework of qmpy, with minimal effort. Sadly,
our starting point, the CH3NH3PbI3 (since CH3NH3 is methylammonium, let us call
the compound MaPbI3 from now on) is not fully resolved in XRD. The best
structure I can find only has the Pb, C, N and I sites determined. So, lets
take this structure (reproduced here from Constantinos C. Stoumpos; et. al.,
Inorganic Chemistry 52 (2013) 9019-9038):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">I</span> <span class="n">C</span> <span class="n">Pb</span> <span class="n">N</span>
 <span class="mf">1.0</span>
<span class="mf">8.849000</span> <span class="mf">0.000000</span> <span class="mf">0.000000</span>
<span class="mf">0.000000</span> <span class="mf">8.849000</span> <span class="mf">0.000000</span>
<span class="mf">0.000000</span> <span class="mf">0.000000</span> <span class="mf">12.642000</span>
<span class="n">C</span> <span class="n">I</span> <span class="n">N</span> <span class="n">Pb</span>
<span class="mi">4</span> <span class="mi">12</span> <span class="mi">4</span> <span class="mi">4</span>
<span class="n">direct</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.3520000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.3520000000</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.8520000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.8520000000</span>
 <span class="mf">0.2858300000</span> <span class="mf">0.2141700000</span> <span class="mf">0.0046000000</span>
 <span class="mf">0.7858300000</span> <span class="mf">0.2858300000</span> <span class="mf">0.0046000000</span>
 <span class="mf">0.2141700000</span> <span class="mf">0.7141700000</span> <span class="mf">0.0046000000</span>
 <span class="mf">0.7141700000</span> <span class="mf">0.7858300000</span> <span class="mf">0.0046000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.2472000000</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.2472000000</span>
 <span class="mf">0.7141700000</span> <span class="mf">0.2141700000</span> <span class="mf">0.5046000000</span>
 <span class="mf">0.2141700000</span> <span class="mf">0.2858300000</span> <span class="mf">0.5046000000</span>
 <span class="mf">0.7858300000</span> <span class="mf">0.7141700000</span> <span class="mf">0.5046000000</span>
 <span class="mf">0.2858300000</span> <span class="mf">0.7858300000</span> <span class="mf">0.5046000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.7472000000</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.7472000000</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.2420000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.2420000000</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.7420000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.7420000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.0000000000</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.0000000000</span>
 <span class="mf">0.0000000000</span> <span class="mf">0.0000000000</span> <span class="mf">0.5000000000</span>
 <span class="mf">0.5000000000</span> <span class="mf">0.5000000000</span> <span class="mf">0.5000000000</span>
</pre></div>
</div>
<p>Now, to populate this structure with hydrogen atoms, lets write a small script
to add atoms to the C and N sites. We can see from the POSCAR that the C-N
pairs are always oriented along the z-direction, so we will add 3 hydrogen
atoms “above” each C and “below” each N.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n_h_bond</span> <span class="o">=</span> <span class="mf">1.01</span> <span class="c1">#A</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c_h_bond</span> <span class="o">=</span> <span class="mf">1.09</span> <span class="c1">#A</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;POSCAR&#39;</span><span class="p">)</span> <span class="c1"># just reading in original structure</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
<span class="go">        if atom.element.symbol == &#39;C&#39;:</span>
<span class="go">            x = np.sin(np.pi/4)*c_h_bond</span>
<span class="go">            x2 = np.sin(np.pi/4)*x</span>
<span class="go">            ref = atom.cart_coord</span>
<span class="go">            s.add_atom(Atom.create(&#39;H&#39;, s.get_coord(ref+[x,   0.0, x2])))</span>
<span class="go">            s.add_atom(Atom.create(&#39;H&#39;, s.get_coord(ref+[-x2, -x2, x2])))</span>
<span class="go">            s.add_atom(Atom.create(&#39;H&#39;, s.get_coord(ref+[-x2,  x2, x2])))</span>
<span class="go">        elif atom.element.symbol == &#39;N&#39;:</span>
<span class="go">            x = np.sin(np.pi/4)*c_h_bond</span>
<span class="go">            x2 = np.sin(np.pi/4)*x</span>
<span class="go">            # Note the angles of the N&#39;s attached hydrogens are rotated</span>
<span class="go">            # relative to the C&#39;s attached hydrogens.</span>
<span class="go">            s.add_atom(Atom.create(&#39;H&#39;, s.get_coord(ref+[-x, 0.0, -x2])))</span>
<span class="go">            s.add_atom(Atom.create(&#39;H&#39;, s.get_coord(ref+[x2,  x2, -x2])))</span>
<span class="go">            s.add_atom(Atom.create(&#39;H&#39;, s.get_coord(ref+[x2, -x2, -x2])))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">io</span><span class="o">.</span><span class="n">poscar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;POSCAR_mod&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can verify that the created structure has the right bond lengths:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;POSCAR_mod&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="go">        d = s.get_distance(a1, a2)</span>
<span class="go">        elts = set([ a1.element.symbol, a2.element.symbol ])</span>
<span class="go">        if elts in [ set([&#39;H&#39;, &#39;N&#39;]), set([&#39;H&#39;, &#39;C&#39;]) ]:</span>
<span class="go">            if d &lt; 1.5:</span>
<span class="go">                print elts, d</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.08999999999</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.08999999999</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.08999999999</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.08999999999</span>
<span class="go">set([u&#39;H&#39;, u&#39;C&#39;]) 1.09000000017</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999987</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999987</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999987</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999987</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
<span class="go">set([u&#39;H&#39;, u&#39;N&#39;]) 1.00999999961</span>
</pre></div>
</div>
<p>As you can see, all N-H and C-H bond lengths are correct.</p>
</div>
<div class="section" id="combinatorial-site-replacements">
<h3>Combinatorial site replacements<a class="headerlink" href="#combinatorial-site-replacements" title="Permalink to this headline">¶</a></h3>
<p>Now that we have a good structure, lets start replacing atoms! First, we need
to specify the substitutions we will make. Lets start with simply isovalent
substitutions for Pb and I. In MePbI3, Methylammonium is a +1 ion, Pb is +2 and
I is -1. We will specify replacements in the form of lists of substitutions.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pb_sub</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Pb&#39;</span><span class="p">,</span> <span class="s1">&#39;Sn&#39;</span><span class="p">,</span>
<span class="go">            &#39;Be&#39;, &#39;Mg&#39;, &#39;Ca&#39;, &#39;Sr&#39;, &#39;Ba&#39;,</span>
<span class="go">            &#39;V&#39;, &#39;Mn&#39;, &#39;Ni&#39;, &#39;Co&#39;, &#39;Fe&#39;, &#39;Zn&#39;,</span>
<span class="go">            &#39;Cd&#39;, &#39;Eu&#39; ,&#39;Ru&#39;, &#39;Pd&#39;, &#39;Pt&#39;, &#39;As&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i_sub</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
<span class="go">            &#39;N&#39;, &#39;S&#39; ]</span>
</pre></div>
</div>
<p>Next, we need to create a directory structure that is reasonable for
understanding where the structures are. This is primarily to make it easier
for people to find the calculations by hand; qmpy would be find with randomly
generated strings for folder names. We organize the structures into nested
directories of the form {anion}/{cation}. The substitutions are implemented by
the <a class="reference internal" href="materials.html#qmpy.Structure.substitute" title="qmpy.Structure.substitute"><code class="xref py py-func docutils literal"><span class="pre">substitute()</span></code></a> method.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># first we write a little helper function for making folders</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="go">        if not os.path.exists(path):</span>
<span class="go">            os.mkdir(path)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># now we loop through antion/cation pairs and for each we:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">#   create the POSCAR</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">#   create an Entry</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;example&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">anion</span> <span class="ow">in</span> <span class="n">i_sub</span><span class="p">:</span>
<span class="go">        mkdir(anion)</span>
<span class="go">        for cation in pb_sub:</span>
<span class="go">            new_dir = &#39;%s/%s&#39; % (anion, cation)</span>
<span class="go">            mkdir(new_dir)</span>
<span class="go">            new_struct = s.replace({&#39;Pb&#39;:cation,</span>
<span class="go">                                    &#39;I&#39;:anion})</span>
<span class="go">            io.poscar.write(s, new_dir+&#39;/POSCAR&#39;)</span>
<span class="go">            entry = Entry.create(new_dir+&#39;/POSCAR&#39;, projects=[project])</span>
<span class="go">            entry.save()</span>
<span class="go">            task = Task.create(entry, &#39;static&#39;)</span>
</pre></div>
</div>
</div>
<div class="section" id="running-the-calculations">
<h3>Running the calculations<a class="headerlink" href="#running-the-calculations" title="Permalink to this headline">¶</a></h3>
<p>In order to run calculations with qmpy, we utilize a JobManager and
TaskManager. The role of the TaskManager is to look at the calculations that
have been requested (in the form of Tasks), and will attempt to fill the
available resources with those calculations. The calculations are stored as
Jobs, which tracks where the calculation is being run, and where it came from.
This is where the JobManager takes over, checking all running Jobs, and if it
is found to be done, it is collected. These managers can be accessed through
the oqmd script (qmpy/bin/oqmd) either as a daemon process or, more safely, in
a screen.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ oqmd jobserver -T run
</pre></div>
</div>
<p>and:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ oqmd taskserver -T run
</pre></div>
</div>
<p>As Tasks and Jobs are processed, both of these methods will continuously report
job submissions, task completions, as well as errors encountered.</p>
</div>
</div>
<div class="section" id="other-examples">
<h2>Other examples<a class="headerlink" href="#other-examples" title="Permalink to this headline">¶</a></h2>
<p>Now, we will run through a variety of problems, and demonstrate solutions which
leverage different functionalities with qmpy.</p>
<div class="section" id="identification-of-fcc-decortations">
<h3>Identification of FCC decortations<a class="headerlink" href="#identification-of-fcc-decortations" title="Permalink to this headline">¶</a></h3>
<p>First, we will find all binary entries:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">binaries</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ntypes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fcc</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cu&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ground_state</span><span class="o">.</span><span class="n">structure</span>
</pre></div>
</div>
<p>Then we run through every structure, and see if replacing all atoms with Cu
results in a structure that is equivalent (on volume scaling) with FCC Cu.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fccs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">binaries</span><span class="p">[:</span><span class="mi">100</span><span class="p">]:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">struct</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">structure</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="c1">## Construct a dictionary of elt:replacement_elt pairs</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="c1">## where every replacement is Cu</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">rdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">test</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">rdict</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>                                    <span class="n">in_place</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">if</span> <span class="n">fcc</span> <span class="o">==</span> <span class="n">test</span><span class="p">:</span> <span class="c1"># simple equality testing will work</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">fccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you actually try to run this on the entire database, understand that it
will take a pretty long time! Each entry tested takes between 0.1 and 1
second, so it would take most of 24 hours to run through all 80,000+ binary
database entries.</p>
</div>
</div>
<div class="section" id="deviation-from-vagard-s-law">
<h3>Deviation from Vagard’s Law<a class="headerlink" href="#deviation-from-vagard-s-law" title="Permalink to this headline">¶</a></h3>
<p>Use the element_groups dictionary to look get a list of all simple metals:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">elts</span> <span class="o">=</span> <span class="n">element_groups</span><span class="p">[</span><span class="s1">&#39;simple-metals&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Then, for each pair of metals get all of the entries, and their volumes.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">vols</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">elts</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">entries</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">get_list</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">vol</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">volume_pa</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">vols</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">vol</span><span class="p">]</span>
</pre></div>
</div>
<p>Then, for every composition get the Vagard’s law volume.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">vagards</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">vols</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">comp</span> <span class="o">=</span> <span class="n">parse_comp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="c1"># returns a elt:amt dictionary</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">uc</span> <span class="o">=</span> <span class="n">unit_comp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="c1"># reduces to a total of 1 atom</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">vvol</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">for</span> <span class="n">elt</span><span class="p">,</span> <span class="n">amt</span> <span class="ow">in</span> <span class="n">uc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">vvol</span> <span class="o">+=</span> <span class="n">elements</span><span class="p">[</span><span class="n">elt</span><span class="p">][</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">amt</span>
</pre></div>
</div>
<p>More things you can do:
* Calculate an average error for each system
* Make a scatter plot for a few binaries show in volume vs x
* Look for cases where some are above and some are below
* Get relaxed volume of all stable compounds
* What about including the “nearly stable”</p>
</div>
<div class="section" id="compute-all-a-b-bond-lengths">
<h3>Compute all A-B bond lengths<a class="headerlink" href="#compute-all-a-b-bond-lengths" title="Permalink to this headline">¶</a></h3>
<p>This script loops over pairs of elements, gets the binary PhaseSpace, and then
loops over structures on the convex hull.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">elts</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="c1"># do logic</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">if</span> <span class="n">e1</span> <span class="o">==</span> <span class="n">e2</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="k">break</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">ps</span> <span class="o">=</span> <span class="n">PhaseSpace</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">k</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">calculation</span><span class="o">.</span><span class="n">input</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">ntypes</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="k">continue</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">dists</span> <span class="o">=</span> <span class="n">get_pair_distances</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="nb">print</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">bonds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="integrating-with-sci-kit-learn">
<h3>Integrating with Sci-kit Learn<a class="headerlink" href="#integrating-with-sci-kit-learn" title="Permalink to this headline">¶</a></h3>
<p>First, the necessary imports:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="k">import</span> <span class="n">SVR</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">cross_validation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">linear_model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">grid_search</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">qmpy</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>As an example problem, we will build a very simple model that predicts the
volume of a compound at a given composition based only on the composition:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">elts</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">symbol__in</span><span class="o">=</span><span class="n">element_groups</span><span class="p">[</span><span class="s1">&#39;simple-metals&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">out_elts</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">symbol__in</span><span class="o">=</span><span class="n">element_groups</span><span class="p">[</span><span class="s1">&#39;simple-metals&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">models</span> <span class="o">=</span> <span class="n">Calculation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">path__contains</span><span class="o">=</span><span class="s1">&#39;icsd&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">composition__element_set</span><span class="o">=</span><span class="n">out_elts</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;composition_id&#39;</span><span class="p">,</span> <span class="s1">&#39;output__volume_pa&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we will build a fit set and test set:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_basic_composition_descriptors</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">cross_validation</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p>Now to actually implement the model:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">clf</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="more-examples">
<h2>More examples<a class="headerlink" href="#more-examples" title="Permalink to this headline">¶</a></h2>
<p>For more examples check in qmpy/examples for a variety of scripts that
demonstrate these and other tasks.</p>
<table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Script</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>sklearn/build_model.py</td>
<td>Build a volume model using sklearn to
predict structure volume based only on
composition.</td>
</tr>
<tr class="row-odd"><td>structures/modify_CNPbI3.py</td>
<td>Take an incomplete structure CNPbI3, that is
supposed to be (CH3NH3)PbI3, and add missing
H atoms.</td>
</tr>
<tr class="row-even"><td>structures/make_protos.py</td>
<td>Take a base structure and create a variety
of decorations.</td>
</tr>
<tr class="row-odd"><td>structures/find_layered.py</td>
<td>Search through the database of structures
for cases where the structure is not fully
connected, i.e. layered structures.</td>
</tr>
<tr class="row-even"><td>structures/bond_lengths.py</td>
<td>Compute average A-B bond lengths for all A-B
pairs, using all stable structures.</td>
</tr>
<tr class="row-odd"><td>database/discovery_rate.py</td>
<td>Using reference information from the ICSD
and measures of structural uniqueness find
the nominal year of <a href="#id1"><span class="problematic" id="id2">`</span></a>discovery’ for all ICSD
structures.</td>
</tr>
<tr class="row-even"><td>database/precipitates.py</td>
<td>Screen for good precipitate strengtheners.
Creates the results used in &lt;insert ref&gt;</td>
</tr>
<tr class="row-odd"><td>database/Li-M-O_screen.py</td>
<td>Screen for (MO_x).(LiO_2) compounds for
hybrid Li-ion/Li-O2 electrode materials.
Reproduces the results used in &lt;insert ref&gt;.</td>
</tr>
<tr class="row-even"><td>database/oqmd_vs_expt.py</td>
<td>Compare OQMD formation energies with
experimental formation energies.</td>
</tr>
<tr class="row-odd"><td>analysis/chem_pots.py</td>
<td>Plot of all modified chemical potentials.</td>
</tr>
<tr class="row-even"><td>analysis/pot_fitting.py</td>
<td>Fit chemical potentials.</td>
</tr>
<tr class="row-odd"><td>analysis/get_formations.py</td>
<td>Calculation formation energies based on new
chemical potentials.</td>
</tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorials</a><ul>
<li><a class="reference internal" href="#database-entries">Database entries</a></li>
<li><a class="reference internal" href="#creating-a-structure">Creating a structure</a></li>
<li><a class="reference internal" href="#first-principles-calculations">First Principles Calculations</a></li>
<li><a class="reference internal" href="#searching-for-models">Searching for models</a><ul>
<li><a class="reference internal" href="#searching-for-entries-based-on-stability">Searching for entries based on stability</a></li>
<li><a class="reference internal" href="#searching-for-entries-based-on-composition">Searching for entries based on composition</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-searching">Advanced searching</a><ul>
<li><a class="reference internal" href="#aggregation-and-annotation">Aggregation and Annotation</a></li>
<li><a class="reference internal" href="#complex-searches">Complex searches</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-qmpy-to-manage-a-high-throughput-calculation-project">Using qmpy to manage a high-throughput calculation project</a><ul>
<li><a class="reference internal" href="#setting-up-computational-resources">Setting up computational resources</a></li>
<li><a class="reference internal" href="#working-with-structures">Working with Structures</a></li>
<li><a class="reference internal" href="#combinatorial-site-replacements">Combinatorial site replacements</a></li>
<li><a class="reference internal" href="#running-the-calculations">Running the calculations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-examples">Other examples</a><ul>
<li><a class="reference internal" href="#identification-of-fcc-decortations">Identification of FCC decortations</a></li>
<li><a class="reference internal" href="#deviation-from-vagard-s-law">Deviation from Vagard’s Law</a></li>
<li><a class="reference internal" href="#compute-all-a-b-bond-lengths">Compute all A-B bond lengths</a></li>
<li><a class="reference internal" href="#integrating-with-sci-kit-learn">Integrating with Sci-kit Learn</a></li>
</ul>
</li>
<li><a class="reference internal" href="#more-examples">More examples</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="getting_started.html"
                        title="previous chapter">Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="models.html"
                        title="next chapter">Data models</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/tutorials.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="models.html" title="Data models"
             >next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Installation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">qmpy 1.1.0a documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, Scott Kirklin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.
    </div>
  </body>
</html>