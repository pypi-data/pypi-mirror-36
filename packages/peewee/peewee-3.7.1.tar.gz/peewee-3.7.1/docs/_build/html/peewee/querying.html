
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Querying &#8212; peewee 3.6.4 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Query operators" href="query_operators.html" />
    <link rel="prev" title="Models and Fields" href="models.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="query_operators.html" title="Query operators"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Models and Fields"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">peewee 3.6.4 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="querying">
<span id="id1"></span><h1>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¶</a></h1>
<p>This section will cover the basic CRUD operations commonly performed on a
relational database:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.create()</span></code></a>, for executing <em>INSERT</em> queries.</li>
<li><a class="reference internal" href="api.html#Model.save" title="Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.save()</span></code></a> and <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.update()</span></code></a>, for executing <em>UPDATE</em>
queries.</li>
<li><a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.delete_instance()</span></code></a> and <a class="reference internal" href="api.html#Model.delete" title="Model.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.delete()</span></code></a>, for executing
<em>DELETE</em> queries.</li>
<li><a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.select()</span></code></a>, for executing <em>SELECT</em> queries.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is also a large collection of example queries taken from the
<a class="reference external" href="https://pgexercises.com/">Postgresql Exercises</a> website. Examples are
listed on the <a class="reference internal" href="query_examples.html#query-examples"><span class="std std-ref">query examples</span></a> document.</p>
</div>
<div class="section" id="creating-a-new-record">
<h2>Creating a new record<a class="headerlink" href="#creating-a-new-record" title="Permalink to this headline">¶</a></h2>
<p>You can use <a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.create()</span></code></a> to create a new model instance. This method
accepts keyword arguments, where the keys correspond to the names of the
model’s fields. A new instance is returned and a row is added to the table.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="go">&lt;__main__.User object at 0x2529350&gt;</span>
</pre></div>
</div>
<p>This will <em>INSERT</em> a new row into the database. The primary key will
automatically be retrieved and stored on the model instance.</p>
<p>Alternatively, you can build up a model instance programmatically and then call
<a class="reference internal" href="api.html#Model.save" title="Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># save() returns the number of rows modified.</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;Huey&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">id</span>
<span class="go">2</span>
</pre></div>
</div>
<p>When a model has a foreign key, you can directly assign a model instance to the
foreign key field when creating a new record.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">huey</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Hello!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also use the value of the related object’s primary key:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Hello again!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you simply wish to insert data and do not need to create a model instance,
you can use <a class="reference internal" href="api.html#Model.insert" title="Model.insert"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.insert()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;Mickey&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="go">3</span>
</pre></div>
</div>
<p>After executing the insert query, the primary key of the new row is returned.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are several ways you can speed up bulk insert operations. Check out
the <a class="reference internal" href="#bulk-inserts"><span class="std std-ref">Bulk inserts</span></a> recipe section for more information.</p>
</div>
</div>
<div class="section" id="bulk-inserts">
<span id="id2"></span><h2>Bulk inserts<a class="headerlink" href="#bulk-inserts" title="Permalink to this headline">¶</a></h2>
<p>There are a couple of ways you can load lots of data quickly. The naive
approach is to simply call <a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.create()</span></code></a> in a loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data_source</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="s1">&#39;val1-1&#39;</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="s1">&#39;val1-2&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="s1">&#39;val2-1&#39;</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="s1">&#39;val2-2&#39;</span><span class="p">},</span>
    <span class="c1"># ...</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">data_dict</span> <span class="ow">in</span> <span class="n">data_source</span><span class="p">:</span>
    <span class="n">MyModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>The above approach is slow for a couple of reasons:</p>
<ol class="arabic simple">
<li>If you are not wrapping the loop in a transaction then each call to
<a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create()</span></code></a> happens in its own transaction. That is going to be
really slow!</li>
<li>There is a decent amount of Python logic getting in your way, and each
<code class="xref py py-class docutils literal notranslate"><span class="pre">InsertQuery</span></code> must be generated and parsed into SQL.</li>
<li>That’s a lot of data (in terms of raw bytes of SQL) you are sending to your
database to parse.</li>
<li>We are retrieving the <em>last insert id</em>, which causes an additional query to
be executed in some cases.</li>
</ol>
<p>You can get a significant speedup by simply wrapping this in a transaction with
<a class="reference internal" href="api.html#Database.atomic" title="Database.atomic"><code class="xref py py-meth docutils literal notranslate"><span class="pre">atomic()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is much faster.</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">data_dict</span> <span class="ow">in</span> <span class="n">data_source</span><span class="p">:</span>
        <span class="n">MyModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code still suffers from points 2, 3 and 4. We can get another big
boost by using <a class="reference internal" href="api.html#Model.insert_many" title="Model.insert_many"><code class="xref py py-meth docutils literal notranslate"><span class="pre">insert_many()</span></code></a>. This method accepts a list of
tuples or dictionaries, and inserts multiple rows in a single query:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data_source</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="s1">&#39;val1-1&#39;</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="s1">&#39;val1-2&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="s1">&#39;val2-1&#39;</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="s1">&#39;val2-2&#39;</span><span class="p">},</span>
    <span class="c1"># ...</span>
<span class="p">]</span>

<span class="c1"># Fastest way to INSERT multiple rows.</span>
<span class="n">MyModel</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="api.html#Model.insert_many" title="Model.insert_many"><code class="xref py py-meth docutils literal notranslate"><span class="pre">insert_many()</span></code></a> method also accepts a list of row-tuples,
provided you also specify the corresponding fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can INSERT tuples as well...</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;val1-1&#39;</span><span class="p">,</span> <span class="s1">&#39;val1-2&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;val2-1&#39;</span><span class="p">,</span> <span class="s1">&#39;val2-2&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;val3-1&#39;</span><span class="p">,</span> <span class="s1">&#39;val3-2&#39;</span><span class="p">)]</span>

<span class="c1"># But we need to indicate which fields the values correspond to.</span>
<span class="n">MyModel</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">MyModel</span><span class="o">.</span><span class="n">field1</span><span class="p">,</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">field2</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>It is also a good practice to wrap the bulk insert in a transaction:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can, of course, wrap this in a transaction as well:</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="n">MyModel</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SQLite users should be aware of some caveats when using bulk inserts.
Specifically, your SQLite3 version must be 3.7.11.0 or newer to take
advantage of the bulk insert API. Additionally, by default SQLite limits
the number of bound variables in a SQL query to <code class="docutils literal notranslate"><span class="pre">999</span></code>.</p>
</div>
<div class="section" id="inserting-rows-in-batches">
<h3>Inserting rows in batches<a class="headerlink" href="#inserting-rows-in-batches" title="Permalink to this headline">¶</a></h3>
<p>Depending on the number of rows in your data source, you may need to break it
up into chunks. SQLite in particular typically has a <a class="reference external" href="https://www.sqlite.org/limits.html#max_variable_number">limit of 999</a>
variables-per-query (batch size would then be roughly 1000 / row length).</p>
<p>You can write a loop to batch your data into chunks (in which case it is
<strong>strongly recommended</strong> you use a transaction):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Insert rows 100 at a time.</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_source</span><span class="p">),</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">MyModel</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data_source</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>Peewee comes with a <a class="reference internal" href="api.html#chunked" title="chunked"><code class="xref py py-func docutils literal notranslate"><span class="pre">chunked()</span></code></a> helper function which you can use for
<em>efficiently</em> chunking a generic iterable into a series of <em>batch</em>-sized
iterables:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="n">chunked</span>

<span class="c1"># Insert rows 100 at a time.</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">chunked</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">MyModel</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="alternatives">
<h3>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="api.html#Model.bulk_create" title="Model.bulk_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.bulk_create()</span></code></a> method behaves much like
<a class="reference internal" href="api.html#Model.insert_many" title="Model.insert_many"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.insert_many()</span></code></a>, but instead it accepts a list of unsaved model
instances to insert, and it optionally accepts a batch-size parameter. To use
the <a class="reference internal" href="api.html#Model.bulk_create" title="Model.bulk_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bulk_create()</span></code></a> API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read list of usernames from a file, for example.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;user_list.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="c1"># Create a list of unsaved User instances.</span>
    <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

<span class="c1"># Wrap the operation in a transaction and batch INSERT the users</span>
<span class="c1"># 100 at a time.</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="n">User</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are using Postgresql (which supports the <code class="docutils literal notranslate"><span class="pre">RETURNING</span></code> clause), then
the previously-unsaved model instances will have their new primary key
values automatically populated.</p>
</div>
<p>Alternatively, you can use the <a class="reference internal" href="api.html#Database.batch_commit" title="Database.batch_commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Database.batch_commit()</span></code></a> helper to
process chunks of rows inside <em>batch</em>-sized transactions. This method also
provides a workaround for databases besides Postgresql, when the primary-key of
the newly-created rows must be obtained.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># List of row data to insert.</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;u1&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;u2&#39;</span><span class="p">},</span> <span class="o">...</span><span class="p">]</span>

<span class="c1"># Assume there are 789 items in row_data. The following code will result in</span>
<span class="c1"># 8 total transactions (7x100 rows + 1x89 rows).</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">batch_commit</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="bulk-loading-from-another-table">
<h3>Bulk-loading from another table<a class="headerlink" href="#bulk-loading-from-another-table" title="Permalink to this headline">¶</a></h3>
<p>If the data you would like to bulk load is stored in another table, you can
also create <em>INSERT</em> queries whose source is a <em>SELECT</em> query. Use the
<a class="reference internal" href="api.html#Model.insert_from" title="Model.insert_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.insert_from()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">TweetArchive</span>
       <span class="o">.</span><span class="n">insert_from</span><span class="p">(</span>
           <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">message</span><span class="p">),</span>
           <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">TweetArchive</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">TweetArchive</span><span class="o">.</span><span class="n">message</span><span class="p">])</span>
       <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
</pre></div>
</div>
<p>The above query is equivalent to the following SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;tweet_archive&quot;</span> <span class="p">(</span><span class="ss">&quot;user_id&quot;</span><span class="p">,</span> <span class="ss">&quot;message&quot;</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="ss">&quot;user_id&quot;</span><span class="p">,</span> <span class="ss">&quot;message&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;tweet&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="updating-existing-records">
<h2>Updating existing records<a class="headerlink" href="#updating-existing-records" title="Permalink to this headline">¶</a></h2>
<p>Once a model instance has a primary key, any subsequent call to
<a class="reference internal" href="api.html#Model.save" title="Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> will result in an <em>UPDATE</em> rather than another <em>INSERT</em>.
The model’s primary key will not change:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># save() returns the number of rows modified.</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">id</span>
<span class="go">2</span>
</pre></div>
</div>
<p>If you want to update multiple records, issue an <em>UPDATE</em> query. The following
example will update all <code class="docutils literal notranslate"><span class="pre">Tweet</span></code> objects, marking them as <em>published</em>, if they
were created before today. <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.update()</span></code></a> accepts keyword arguments
where the keys correspond to the model’s field names:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">&lt;</span> <span class="n">today</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c1"># Returns the number of rows that were updated.</span>
<span class="go">4</span>
</pre></div>
</div>
<p>For more information, see the documentation on <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.update()</span></code></a> and
<a class="reference internal" href="api.html#Update" title="Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you would like more information on performing atomic updates (such as
incrementing the value of a column), check out the <a class="reference internal" href="#atomic-updates"><span class="std std-ref">atomic update</span></a>
recipes.</p>
</div>
</div>
<div class="section" id="atomic-updates">
<span id="id3"></span><h2>Atomic updates<a class="headerlink" href="#atomic-updates" title="Permalink to this headline">¶</a></h2>
<p>Peewee allows you to perform atomic updates. Let’s suppose we need to update
some counters. The naive approach would be to write something like this:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Do not do this!</strong> Not only is this slow, but it is also vulnerable to race
conditions if multiple processes are updating the counter at the same time.</p>
<p>Instead, you can update the counters atomically using <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">update()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">counter</span><span class="o">=</span><span class="n">Stat</span><span class="o">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>You can make these update statements as complex as you like. Let’s give all our
employees a bonus equal to their previous bonus plus 10% of their salary:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bonus</span><span class="o">=</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">bonus</span> <span class="o">+</span> <span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c1"># Give everyone a bonus!</span>
</pre></div>
</div>
<p>We can even use a subquery to update the value of a column. Suppose we had a
denormalized column on the <code class="docutils literal notranslate"><span class="pre">User</span></code> model that stored the number of tweets a
user had made, and we updated this value periodically. Here is how you might
write such a query:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subquery</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">update</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">num_tweets</span><span class="o">=</span><span class="n">subquery</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">update</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="upsert">
<h3>Upsert<a class="headerlink" href="#upsert" title="Permalink to this headline">¶</a></h3>
<p>Peewee provides support for varying types of upsert functionality. With SQLite
prior to 3.24.0 and MySQL, Peewee offers the <a class="reference internal" href="api.html#Model.replace" title="Model.replace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">replace()</span></code></a>, which
allows you to insert a record or, in the event of a constraint violation,
replace the existing record.</p>
<p>Example of using <a class="reference internal" href="api.html#Model.replace" title="Model.replace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">replace()</span></code></a> and <a class="reference internal" href="api.html#Insert.on_conflict_replace" title="Insert.on_conflict_replace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_conflict_replace()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">last_login</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Insert or update the user. The &quot;last_login&quot; value will be updated</span>
<span class="c1"># regardless of whether the user existed previously.</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
           <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;the-user&#39;</span><span class="p">,</span> <span class="n">last_login</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
           <span class="o">.</span><span class="n">execute</span><span class="p">())</span>

<span class="c1"># This query is equivalent:</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
           <span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;the-user&#39;</span><span class="p">,</span> <span class="n">last_login</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
           <span class="o">.</span><span class="n">on_conflict_replace</span><span class="p">()</span>
           <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In addition to <em>replace</em>, SQLite, MySQL and Postgresql provide an <em>ignore</em>
action (see: <a class="reference internal" href="api.html#Insert.on_conflict_ignore" title="Insert.on_conflict_ignore"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_conflict_ignore()</span></code></a>) if you simply wish to
insert and ignore any potential constraint violation.</p>
</div>
<p><strong>MySQL</strong> supports upsert via the <em>ON DUPLICATE KEY UPDATE</em> clause. For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">last_login</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">login_count</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>

<span class="c1"># Insert a new user.</span>
<span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;huey&#39;</span><span class="p">,</span> <span class="n">login_count</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Simulate the user logging in. The login count and timestamp will be</span>
<span class="c1"># either created or updated correctly.</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">rowid</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;huey&#39;</span><span class="p">,</span> <span class="n">last_login</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">login_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="o">.</span><span class="n">on_conflict</span><span class="p">(</span>
             <span class="n">preserve</span><span class="o">=</span><span class="p">[</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span><span class="p">],</span>  <span class="c1"># Use the value we would have inserted.</span>
             <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span><span class="p">:</span> <span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
         <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
</pre></div>
</div>
<p>In the above example, we could safely invoke the upsert query as many times as
we wanted. The login count will be incremented atomically, the last login
column will be updated, and no duplicate rows will be created.</p>
<p><strong>Postgresql and SQLite</strong> (3.24.0 and newer) provide a different syntax that
allows for more granular control over which constraint violation should trigger
the conflict resolution, and what values should be updated or preserved.</p>
<p>Example of using <a class="reference internal" href="api.html#Insert.on_conflict" title="Insert.on_conflict"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_conflict()</span></code></a> to perform a Postgresql-style
upsert (or SQLite 3.24+):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">last_login</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">login_count</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>

<span class="c1"># Insert a new user.</span>
<span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;huey&#39;</span><span class="p">,</span> <span class="n">login_count</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Simulate the user logging in. The login count and timestamp will be</span>
<span class="c1"># either created or updated correctly.</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">rowid</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;huey&#39;</span><span class="p">,</span> <span class="n">last_login</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">login_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="o">.</span><span class="n">on_conflict</span><span class="p">(</span>
             <span class="n">conflict_target</span><span class="o">=</span><span class="p">[</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">],</span>  <span class="c1"># Which constraint?</span>
             <span class="n">preserve</span><span class="o">=</span><span class="p">[</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span><span class="p">],</span>  <span class="c1"># Use the value we would have inserted.</span>
             <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span><span class="p">:</span> <span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
         <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
</pre></div>
</div>
<p>In the above example, we could safely invoke the upsert query as many times as
we wanted. The login count will be incremented atomically, the last login
column will be updated, and no duplicate rows will be created.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The main difference between MySQL and Postgresql/SQLite is that Postgresql
and SQLite require that you specify a <code class="docutils literal notranslate"><span class="pre">conflict_target</span></code>.</p>
</div>
<p>For more information, see <a class="reference internal" href="api.html#Insert.on_conflict" title="Insert.on_conflict"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.on_conflict()</span></code></a> and
<a class="reference internal" href="api.html#OnConflict" title="OnConflict"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnConflict</span></code></a>.</p>
</div>
</div>
<div class="section" id="deleting-records">
<h2>Deleting records<a class="headerlink" href="#deleting-records" title="Permalink to this headline">¶</a></h2>
<p>To delete a single model instance, you can use the
<a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.delete_instance()</span></code></a> shortcut. <a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">delete_instance()</span></code></a>
will delete the given model instance and can optionally delete any dependent
objects recursively (by specifying <cite>recursive=True</cite>).</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>  <span class="c1"># Returns the number of rows deleted.</span>
<span class="go">1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">UserDoesNotExist: instance matching query does not exist:</span>
<span class="go">SQL: SELECT t1.&quot;id&quot;, t1.&quot;username&quot; FROM &quot;user&quot; AS t1 WHERE t1.&quot;id&quot; = ?</span>
<span class="go">PARAMS: [1]</span>
</pre></div>
</div>
<p>To delete an arbitrary set of rows, you can issue a <em>DELETE</em> query. The
following will delete all <code class="docutils literal notranslate"><span class="pre">Tweet</span></code> objects that are over one year old:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">&lt;</span> <span class="n">one_year_ago</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c1"># Returns the number of rows deleted.</span>
<span class="go">7</span>
</pre></div>
</div>
<p>For more information, see the documentation on:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.delete_instance()</span></code></a></li>
<li><a class="reference internal" href="api.html#Model.delete" title="Model.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.delete()</span></code></a></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">DeleteQuery</span></code></li>
</ul>
</div>
<div class="section" id="selecting-a-single-record">
<h2>Selecting a single record<a class="headerlink" href="#selecting-a-single-record" title="Permalink to this headline">¶</a></h2>
<p>You can use the <a class="reference internal" href="api.html#Model.get" title="Model.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.get()</span></code></a> method to retrieve a single instance
matching the given query. For primary-key lookups, you can also use the
shortcut method <a class="reference internal" href="api.html#Model.get_by_id" title="Model.get_by_id"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.get_by_id()</span></code></a>.</p>
<p>This method is a shortcut that calls <a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.select()</span></code></a> with the given
query, but limits the result set to a single row. Additionally, if no model
matches the given query, a <code class="docutils literal notranslate"><span class="pre">DoesNotExist</span></code> exception will be raised.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">&lt;__main__.User object at 0x25294d0&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Same as above.</span>
<span class="go">&lt;__main__.User object at 0x252df10&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Also same as above.</span>
<span class="go">&lt;__main__.User object at 0x252dd10&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">username</span>
<span class="go">u&#39;Charlie&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="go">&lt;__main__.User object at 0x2529410&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;nobody&#39;</span><span class="p">)</span>
<span class="go">UserDoesNotExist: instance matching query does not exist:</span>
<span class="go">SQL: SELECT t1.&quot;id&quot;, t1.&quot;username&quot; FROM &quot;user&quot; AS t1 WHERE t1.&quot;username&quot; = ?</span>
<span class="go">PARAMS: [&#39;nobody&#39;]</span>
</pre></div>
</div>
<p>For more advanced operations, you can use <a class="reference internal" href="api.html#SelectBase.get" title="SelectBase.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SelectBase.get()</span></code></a>. The
following query retrieves the latest tweet from the user named <em>charlie</em>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">Tweet</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;charlie&#39;</span><span class="p">)</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">get</span><span class="p">())</span>
<span class="go">&lt;__main__.Tweet object at 0x2623410&gt;</span>
</pre></div>
</div>
<p>For more information, see the documentation on:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Model.get" title="Model.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.get()</span></code></a></li>
<li><a class="reference internal" href="api.html#Model.get_by_id" title="Model.get_by_id"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.get_by_id()</span></code></a></li>
<li><a class="reference internal" href="api.html#Model.get_or_none" title="Model.get_or_none"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.get_or_none()</span></code></a> - if no matching row is found, return <code class="docutils literal notranslate"><span class="pre">None</span></code>.</li>
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.first()</span></code></li>
<li><a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.select()</span></code></a></li>
<li><a class="reference internal" href="api.html#SelectBase.get" title="SelectBase.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SelectBase.get()</span></code></a></li>
</ul>
</div>
<div class="section" id="create-or-get">
<h2>Create or get<a class="headerlink" href="#create-or-get" title="Permalink to this headline">¶</a></h2>
<p>Peewee has one helper method for performing “get/create” type operations:
<a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.get_or_create()</span></code></a>, which first attempts to retrieve the matching
row. Failing that, a new row will be created.</p>
<p>For “create or get” type logic, typically one would rely on a <em>unique</em>
constraint or primary key to prevent the creation of duplicate objects. As an
example, let’s say we wish to implement registering a new user account using
the <a class="reference internal" href="models.html#blog-models"><span class="std std-ref">example User model</span></a>. The <em>User</em> model has a <em>unique</em>
constraint on the username field, so we will rely on the database’s integrity
guarantees to ensure we don’t end up with duplicate usernames:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
<span class="k">except</span> <span class="n">peewee</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
    <span class="c1"># `username` is a unique column, so this username already exists,</span>
    <span class="c1"># making it safe to call .get().</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>You can easily encapsulate this type of logic as a <code class="docutils literal notranslate"><span class="pre">classmethod</span></code> on your own
<code class="docutils literal notranslate"><span class="pre">Model</span></code> classes.</p>
<p>The above example first attempts at creation, then falls back to retrieval,
relying on the database to enforce a unique constraint. If you prefer to
attempt to retrieve the record first, you can use
<a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_or_create()</span></code></a>. This method is implemented along the same
lines as the Django function of the same name. You can use the Django-style
keyword argument filters to specify your <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> conditions. The function
returns a 2-tuple containing the instance and a boolean value indicating if the
object was created.</p>
<p>Here is how you might implement user account creation using
<a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_or_create()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">user</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose we have a different model <code class="docutils literal notranslate"><span class="pre">Person</span></code> and would like to get or create a
person object. The only conditions we care about when retrieving the <code class="docutils literal notranslate"><span class="pre">Person</span></code>
are their first and last names, <strong>but</strong> if we end up needing to create a new
record, we will also specify their date-of-birth and favorite color:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
    <span class="n">first_name</span><span class="o">=</span><span class="n">first_name</span><span class="p">,</span>
    <span class="n">last_name</span><span class="o">=</span><span class="n">last_name</span><span class="p">,</span>
    <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dob&#39;</span><span class="p">:</span> <span class="n">dob</span><span class="p">,</span> <span class="s1">&#39;favorite_color&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Any keyword argument passed to <a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_or_create()</span></code></a> will be used in
the <code class="docutils literal notranslate"><span class="pre">get()</span></code> portion of the logic, except for the <code class="docutils literal notranslate"><span class="pre">defaults</span></code> dictionary,
which will be used to populate values on newly-created instances.</p>
<p>For more details read the documentation for <a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.get_or_create()</span></code></a>.</p>
</div>
<div class="section" id="selecting-multiple-records">
<h2>Selecting multiple records<a class="headerlink" href="#selecting-multiple-records" title="Permalink to this headline">¶</a></h2>
<p>We can use <a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.select()</span></code></a> to retrieve rows from the table. When you
construct a <em>SELECT</em> query, the database will return any rows that correspond
to your query. Peewee allows you to iterate over these rows, as well as use
indexing and slicing operations:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
<span class="go">[&#39;Charlie&#39;, &#39;Huey&#39;, &#39;Peewee&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="go">&lt;__main__.User at 0x7f83e80f5550&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">username</span>
<span class="go">&#39;Huey&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="go">[&lt;__main__.User at 0x7f83e80f53a8&gt;, &lt;__main__.User at 0x7f83e80f5550&gt;]</span>
</pre></div>
</div>
<p><a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> queries are smart, in that you can iterate, index and slice
the query multiple times but the query is only executed once.</p>
<p>In the following example, we will simply call <a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">select()</span></code></a> and
iterate over the return value, which is an instance of <a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>.
This will return all the rows in the <em>User</em> table:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
<span class="gp">...</span>
<span class="go">Charlie</span>
<span class="go">Huey</span>
<span class="go">Peewee</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Subsequent iterations of the same query will not hit the database as the
results are cached. To disable this behavior (to reduce memory usage), call
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.iterator()</span></code> when iterating.</p>
</div>
<p>When iterating over a model that contains a foreign key, be careful with the
way you access values on related models. Accidentally resolving a foreign key
or iterating over a back-reference can cause <a class="reference internal" href="relationships.html#nplusone"><span class="std std-ref">N+1 query behavior</span></a>.</p>
<p>When you create a foreign key, such as <code class="docutils literal notranslate"><span class="pre">Tweet.user</span></code>, you can use the
<em>backref</em> to create a back-reference (<code class="docutils literal notranslate"><span class="pre">User.tweets</span></code>). Back-references
are exposed as <a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> instances:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span>  <span class="c1"># Accessing a foreign key returns the related model.</span>
<span class="go">&lt;tw.User at 0x7f3ceb017f50&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">tweets</span>  <span class="c1"># Accessing a back-reference returns a query.</span>
<span class="go">&lt;peewee.ModelSelect at 0x7f73db3bafd0&gt;</span>
</pre></div>
</div>
<p>You can iterate over the <code class="docutils literal notranslate"><span class="pre">user.tweets</span></code> back-reference just like any other
<a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">hello world</span>
<span class="go">this is fun</span>
<span class="go">look at this picture of my food</span>
</pre></div>
</div>
<p>In addition to returning model instances, <a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> queries can return
dictionaries, tuples and namedtuples. Depending on your use-case, you may find
it easier to work with rows as dictionaries, for example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="go">{&#39;id&#39;: 1, &#39;username&#39;: &#39;Charlie&#39;}</span>
<span class="go">{&#39;id&#39;: 2, &#39;username&#39;: &#39;Huey&#39;}</span>
<span class="go">{&#39;id&#39;: 3, &#39;username&#39;: &#39;Peewee&#39;}</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="api.html#BaseQuery.namedtuples" title="BaseQuery.namedtuples"><code class="xref py py-meth docutils literal notranslate"><span class="pre">namedtuples()</span></code></a>, <a class="reference internal" href="api.html#BaseQuery.tuples" title="BaseQuery.tuples"><code class="xref py py-meth docutils literal notranslate"><span class="pre">tuples()</span></code></a>,
<a class="reference internal" href="api.html#BaseQuery.dicts" title="BaseQuery.dicts"><code class="xref py py-meth docutils literal notranslate"><span class="pre">dicts()</span></code></a> for more information.</p>
<div class="section" id="iterating-over-large-result-sets">
<h3>Iterating over large result-sets<a class="headerlink" href="#iterating-over-large-result-sets" title="Permalink to this headline">¶</a></h3>
<p>By default peewee will cache the rows returned when iterating over a
<a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> query. This is an optimization to allow multiple iterations
as well as indexing and slicing without causing additional queries. This
caching can problematic, however, when you plan to iterate over a large
number of rows.</p>
<p>To reduce the amount of memory used by peewee when iterating over a query, use
the <a class="reference internal" href="api.html#BaseQuery.iterator" title="BaseQuery.iterator"><code class="xref py py-meth docutils literal notranslate"><span class="pre">iterator()</span></code></a> method. This method allows you to iterate
without caching each model returned, using much less memory when iterating over
large result sets.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s assume we&#39;ve got 10 million stat objects to dump to a csv file.</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

<span class="c1"># Our imaginary serializer class</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">CSVSerializer</span><span class="p">()</span>

<span class="c1"># Loop over all the stats and serialize.</span>
<span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
    <span class="n">serializer</span><span class="o">.</span><span class="n">serialize_object</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</pre></div>
</div>
<p>For simple queries you can see further speed improvements by returning rows as
dictionaries, namedtuples or tuples. The following methods can be used on any
<a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> query to change the result row type:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#BaseQuery.dicts" title="BaseQuery.dicts"><code class="xref py py-meth docutils literal notranslate"><span class="pre">dicts()</span></code></a></li>
<li><a class="reference internal" href="api.html#BaseQuery.namedtuples" title="BaseQuery.namedtuples"><code class="xref py py-meth docutils literal notranslate"><span class="pre">namedtuples()</span></code></a></li>
<li><a class="reference internal" href="api.html#BaseQuery.tuples" title="BaseQuery.tuples"><code class="xref py py-meth docutils literal notranslate"><span class="pre">tuples()</span></code></a></li>
</ul>
<p>When iterating over a large number of rows that contain columns from multiple
tables, peewee will reconstruct the model graph for each row returned. This
operation can be slow for complex graphs. For example, if we were selecting a
list of tweets along with the username and avatar of the tweet’s author, Peewee
would have to create two objects for each row (a tweet and a user). In addition
to the above row-types, there is a fourth method <a class="reference internal" href="api.html#BaseQuery.objects" title="BaseQuery.objects"><code class="xref py py-meth docutils literal notranslate"><span class="pre">objects()</span></code></a>
which will return the rows as model instances, but will not attempt to resolve
the model graph.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>  <span class="c1"># Select tweet and user data.</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>

<span class="c1"># Note that the user columns are stored in a separate User instance</span>
<span class="c1"># accessible at tweet.user:</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># Using &quot;.objects()&quot; will not create the tweet.user object and assigns all</span>
<span class="c1"># user attributes to the tweet instance:</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">objects</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
<p>For maximum performance, you can execute queries and then iterate over the
results using the underlying database cursor. <a class="reference internal" href="api.html#Database.execute" title="Database.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Database.execute()</span></code></a>
accepts a query object, executes the query, and returns a DB-API 2.0 <code class="docutils literal notranslate"><span class="pre">Cursor</span></code>
object. The cursor will return the raw row-tuples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="filtering-records">
<h2>Filtering records<a class="headerlink" href="#filtering-records" title="Permalink to this headline">¶</a></h2>
<p>You can filter for particular records using normal python operators. Peewee
supports a wide variety of <a class="reference internal" href="query_operators.html#query-operators"><span class="std std-ref">query operators</span></a>.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">is_published</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Charlie -&gt; hello world</span>
<span class="go">Charlie -&gt; this is fun</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Really old tweet 2010-01-01 00:00:00</span>
</pre></div>
</div>
<p>You can also filter across joins:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;Charlie&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<span class="go">hello world</span>
<span class="go">this is fun</span>
<span class="go">look at this picture of my food</span>
</pre></div>
</div>
<p>If you want to express a complex query, use parentheses and python’s bitwise
<em>or</em> and <em>and</em> operators:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;Charlie&#39;</span><span class="p">)</span> <span class="o">|</span>
<span class="gp">... </span>    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;Peewee Herman&#39;</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that Peewee uses <strong>bitwise</strong> operators (<code class="docutils literal notranslate"><span class="pre">&amp;</span></code> and <code class="docutils literal notranslate"><span class="pre">|</span></code>) rather than
logical operators (<code class="docutils literal notranslate"><span class="pre">and</span></code> and <code class="docutils literal notranslate"><span class="pre">or</span></code>). The reason for this is that Python
coerces the return value of logical operations to a boolean value. This is
also the reason why “IN” queries must be expressed using <code class="docutils literal notranslate"><span class="pre">.in_()</span></code> rather
than the <code class="docutils literal notranslate"><span class="pre">in</span></code> operator.</p>
</div>
<p>Check out <a class="reference internal" href="query_operators.html#query-operators"><span class="std std-ref">the table of query operations</span></a> to see what
types of queries are possible.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>A lot of fun things can go in the where clause of a query, such as:</p>
<ul class="simple">
<li>A field expression, e.g. <code class="docutils literal notranslate"><span class="pre">User.username</span> <span class="pre">==</span> <span class="pre">'Charlie'</span></code></li>
<li>A function expression, e.g. <code class="docutils literal notranslate"><span class="pre">fn.Lower(fn.Substr(User.username,</span> <span class="pre">1,</span> <span class="pre">1))</span> <span class="pre">==</span> <span class="pre">'a'</span></code></li>
<li>A comparison of one column to another, e.g. <code class="docutils literal notranslate"><span class="pre">Employee.salary</span> <span class="pre">&lt;</span> <span class="pre">(Employee.tenure</span> <span class="pre">*</span> <span class="pre">1000)</span> <span class="pre">+</span> <span class="pre">40000</span></code></li>
</ul>
<p>You can also nest queries, for example tweets by users whose username
starts with “a”:</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># get users whose username starts with &quot;a&quot;</span>
<span class="n">a_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

<span class="c1"># the &quot;.in_()&quot; method signifies an &quot;IN&quot; query</span>
<span class="n">a_user_tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">a_users</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="more-query-examples">
<h3>More query examples<a class="headerlink" href="#more-query-examples" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For a wide range of example queries, see the <a class="reference internal" href="query_examples.html#query-examples"><span class="std std-ref">Query Examples</span></a>
document, which shows how to implements queries from the <a class="reference external" href="https://pgexercises.com/">PostgreSQL Exercises</a>
website.</p>
</div>
<p>Get active users:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Get users who are either staff or superusers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Get tweets by user named “charlie”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;charlie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Get tweets by staff or superusers (assumes FK relationship):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Get tweets by staff or superusers using a subquery:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">staff_super</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
<span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">staff_super</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sorting-records">
<h2>Sorting records<a class="headerlink" href="#sorting-records" title="Permalink to this headline">¶</a></h2>
<p>To return rows in order, use the <a class="reference internal" href="api.html#Query.order_by" title="Query.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">order_by()</span></code></a> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pub_date</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">2010-01-01 00:00:00</span>
<span class="go">2011-06-07 14:08:48</span>
<span class="go">2011-06-07 14:12:57</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">()):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pub_date</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">2011-06-07 14:12:57</span>
<span class="go">2011-06-07 14:08:48</span>
<span class="go">2010-01-01 00:00:00</span>
</pre></div>
</div>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">+</span></code> and <code class="docutils literal notranslate"><span class="pre">-</span></code> prefix operators to indicate ordering:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following queries are equivalent:</span>
<span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>

<span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">-</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">)</span>  <span class="c1"># Note the &quot;-&quot; prefix.</span>

<span class="c1"># Similarly you can use &quot;+&quot; to indicate ascending order, though ascending</span>
<span class="c1"># is the default when no ordering is otherwise specified.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">+</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also order across joins. Assuming you want to order tweets by the
username of the author, then by created_date:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go">query = (Tweet</span>
<span class="go">         .select()</span>
<span class="go">         .join(User)</span>
<span class="go">         .order_by(User.username, Tweet.created_date.desc()))</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;message&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;is_published&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;created_date&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;tweet&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;user&quot;</span> <span class="k">AS</span> <span class="n">t2</span>
  <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;created_date&quot;</span> <span class="k">DESC</span>
</pre></div>
</div>
<p>When sorting on a calculated value, you can either include the necessary SQL
expressions, or reference the alias assigned to the value. Here are two
examples illustrating these methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s start with our base query. We want to get all usernames and the number of</span>
<span class="c1"># tweets they&#39;ve made. We wish to sort this list from users with most tweets to</span>
<span class="c1"># users with fewest tweets.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
</pre></div>
</div>
<p>You can order using the same COUNT expression used in the <code class="docutils literal notranslate"><span class="pre">select</span></code> clause. In
the example below we are ordering by the <code class="docutils literal notranslate"><span class="pre">COUNT()</span></code> of tweet ids descending:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
</pre></div>
</div>
<p>Alternatively, you can reference the alias assigned to the calculated value in
the <code class="docutils literal notranslate"><span class="pre">select</span></code> clause. This method has the benefit of being a bit easier to
read. Note that we are not referring to the named alias directly, but are
wrapping it using the <a class="reference internal" href="api.html#SQL" title="SQL"><code class="xref py py-class docutils literal notranslate"><span class="pre">SQL</span></code></a> helper:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;num_tweets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
</pre></div>
</div>
<p>Or, to do things the “peewee” way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ntweets</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">ntweets</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">ntweets</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-random-records">
<h2>Getting random records<a class="headerlink" href="#getting-random-records" title="Permalink to this headline">¶</a></h2>
<p>Occasionally you may want to pull a random record from the database. You can
accomplish this by ordering by the <em>random</em> or <em>rand</em> function (depending on
your database):</p>
<p>Postgresql and Sqlite use the <em>Random</em> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pick 5 lucky winners:</span>
<span class="n">LotteryNumber</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Random</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>MySQL uses <em>Rand</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pick 5 lucky winners:</span>
<span class="n">LotterNumber</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Rand</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="paginating-records">
<h2>Paginating records<a class="headerlink" href="#paginating-records" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="api.html#Query.paginate" title="Query.paginate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">paginate()</span></code></a> method makes it easy to grab a <em>page</em> or
records. <a class="reference internal" href="api.html#Query.paginate" title="Query.paginate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">paginate()</span></code></a> takes two parameters,
<code class="docutils literal notranslate"><span class="pre">page_number</span></code>, and <code class="docutils literal notranslate"><span class="pre">items_per_page</span></code>.</p>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">Page numbers are 1-based, so the first page of results will be page 1.</p>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">tweet 10</span>
<span class="go">tweet 11</span>
<span class="go">tweet 12</span>
<span class="go">tweet 13</span>
<span class="go">tweet 14</span>
<span class="go">tweet 15</span>
<span class="go">tweet 16</span>
<span class="go">tweet 17</span>
<span class="go">tweet 18</span>
<span class="go">tweet 19</span>
</pre></div>
</div>
<p>If you would like more granular control, you can always use
<a class="reference internal" href="api.html#Query.limit" title="Query.limit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">limit()</span></code></a> and <a class="reference internal" href="api.html#Query.offset" title="Query.offset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">offset()</span></code></a>.</p>
</div>
<div class="section" id="counting-records">
<h2>Counting records<a class="headerlink" href="#counting-records" title="Permalink to this headline">¶</a></h2>
<p>You can count the number of rows in any select query:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">100</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">50</span>
</pre></div>
</div>
<p>Peewee will wrap your query in an outer query that performs a count, which
results in SQL like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">FROM</span> <span class="p">(</span> <span class="p">...</span> <span class="n">your</span> <span class="n">query</span> <span class="p">...</span> <span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="aggregating-records">
<h2>Aggregating records<a class="headerlink" href="#aggregating-records" title="Permalink to this headline">¶</a></h2>
<p>Suppose you have some users and want to get a list of them along with the count
of tweets in each.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>
</pre></div>
</div>
<p>The resulting query will return <em>User</em> objects with all their normal attributes
plus an additional attribute <em>count</em> which will contain the count of tweets for
each user. We use a left outer join to include users who have no tweets.</p>
<p>Let’s assume you have a tagging application and want to find tags that have a
certain number of related objects. For this example we’ll use some different
models in a <a class="reference internal" href="relationships.html#manytomany"><span class="std std-ref">many-to-many</span></a> configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Photo</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PhotoTag</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Photo</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span>
</pre></div>
</div>
<p>Now say we want to find tags that have at least 5 photos associated with them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tag</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PhotoTag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Photo</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<p>This query is equivalent to the following SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;name&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;tag&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;phototag&quot;</span> <span class="k">AS</span> <span class="n">t2</span> <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;photo&quot;</span> <span class="k">AS</span> <span class="n">t3</span> <span class="k">ON</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;photo_id&quot;</span> <span class="o">=</span> <span class="n">t3</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;name&quot;</span>
<span class="k">HAVING</span> <span class="k">Count</span><span class="p">(</span><span class="n">t3</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Suppose we want to grab the associated count and store it on the tag:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tag</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PhotoTag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Photo</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieving-scalar-values">
<h2>Retrieving Scalar Values<a class="headerlink" href="#retrieving-scalar-values" title="Permalink to this headline">¶</a></h2>
<p>You can retrieve scalar values by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.scalar()</span></code>. For
instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">PageView</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Distinct</span><span class="p">(</span><span class="n">PageView</span><span class="o">.</span><span class="n">url</span><span class="p">)))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<span class="go">100</span>
</pre></div>
</div>
<p>You can retrieve multiple scalar values by passing <code class="docutils literal notranslate"><span class="pre">as_tuple=True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Employee</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">fn</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">),</span> <span class="n">fn</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="go">(30000, 50000)</span>
</pre></div>
</div>
</div>
<div class="section" id="window-functions">
<span id="id5"></span><h2>Window functions<a class="headerlink" href="#window-functions" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="api.html#Window" title="Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> function refers to an aggregate function that operates on
a sliding window of data that is being processed as part of a <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> query.
Window functions make it possible to do things like:</p>
<ol class="arabic simple">
<li>Perform aggregations against subsets of a result-set.</li>
<li>Calculate a running total.</li>
<li>Rank results.</li>
<li>Compare a row value to a value in the preceding (or succeeding!) row(s).</li>
</ol>
<p>peewee comes with support for SQL window functions, which can be created by
calling <a class="reference internal" href="api.html#Function.over" title="Function.over"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Function.over()</span></code></a> and passing in your partitioning or ordering
parameters.</p>
<p>For the following examples, we’ll use the following model and sample data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sample</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span>
<span class="n">Sample</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>Our sample table now contains:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="47%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">id</th>
<th class="head">counter</th>
<th class="head">value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>1</td>
<td>10.0</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>1</td>
<td>20.0</td>
</tr>
<tr class="row-even"><td>3</td>
<td>2</td>
<td>1.0</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>2</td>
<td>3.0</td>
</tr>
<tr class="row-even"><td>5</td>
<td>3</td>
<td>100.0</td>
</tr>
</tbody>
</table>
<div class="section" id="ordered-windows">
<h3>Ordered Windows<a class="headerlink" href="#ordered-windows" title="Permalink to this headline">¶</a></h3>
<p>Let’s calculate a running sum of the <code class="docutils literal notranslate"><span class="pre">value</span></code> field. In order for it to be a
“running” sum, we need it to be ordered, so we’ll order with respect to the
Sample’s <code class="docutils literal notranslate"><span class="pre">id</span></code> field:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>

<span class="c1"># 1    10.    10.</span>
<span class="c1"># 1    20.    30.</span>
<span class="c1"># 2     1.    31.</span>
<span class="c1"># 2     3.    34.</span>
<span class="c1"># 3   100    134.</span>
</pre></div>
</div>
<p>For another example, we’ll calculate the difference between the current value
and the previous value, when ordered by the <code class="docutils literal notranslate"><span class="pre">id</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">difference</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">fn</span><span class="o">.</span><span class="n">LAG</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">difference</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;diff&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

<span class="c1"># 1    10.   NULL</span>
<span class="c1"># 1    20.    10.  -- (20 - 10)</span>
<span class="c1"># 2     1.   -19.  -- (1 - 20)</span>
<span class="c1"># 2     3.     2.  -- (3 - 1)</span>
<span class="c1"># 3   100     97.  -- (100 - 3)</span>
</pre></div>
</div>
</div>
<div class="section" id="partitioned-windows">
<h3>Partitioned Windows<a class="headerlink" href="#partitioned-windows" title="Permalink to this headline">¶</a></h3>
<p>Let’s calculate the average <code class="docutils literal notranslate"><span class="pre">value</span></code> for each distinct “counter” value. Notice
that there are three possible values for the <code class="docutils literal notranslate"><span class="pre">counter</span></code> field (1, 2, and 3).
We can do this by calculating the <code class="docutils literal notranslate"><span class="pre">AVG()</span></code> of the <code class="docutils literal notranslate"><span class="pre">value</span></code> column over a
window that is partitioned depending on the <code class="docutils literal notranslate"><span class="pre">counter</span></code> field:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">AVG</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;cavg&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">cavg</span><span class="p">)</span>

<span class="c1"># 1    10.    15.</span>
<span class="c1"># 1    20.    15.</span>
<span class="c1"># 2     1.     2.</span>
<span class="c1"># 2     3.     2.</span>
<span class="c1"># 3   100    100.</span>
</pre></div>
</div>
<p>We can use ordering within partitions by specifying both the <code class="docutils literal notranslate"><span class="pre">order_by</span></code> and
<code class="docutils literal notranslate"><span class="pre">partition_by</span></code> parameters. For an example, let’s rank the samples by value
within each distinct <code class="docutils literal notranslate"><span class="pre">counter</span></code> group.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">RANK</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
        <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">],</span>
        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>

<span class="c1"># 1    10.    1</span>
<span class="c1"># 1    20.    2</span>
<span class="c1"># 2     1.    1</span>
<span class="c1"># 2     3.    2</span>
<span class="c1"># 3   100     1</span>
</pre></div>
</div>
</div>
<div class="section" id="bounded-windows">
<h3>Bounded windows<a class="headerlink" href="#bounded-windows" title="Permalink to this headline">¶</a></h3>
<p>By default, window functions are evaluated using an <em>unbounded preceding</em> start
for the window, and the <em>current row</em> as the end. We can change the bounds of
the window our aggregate functions operate on by specifying a <code class="docutils literal notranslate"><span class="pre">start</span></code> and/or
<code class="docutils literal notranslate"><span class="pre">end</span></code> in the call to <a class="reference internal" href="api.html#Function.over" title="Function.over"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Function.over()</span></code></a>. Additionally, Peewee comes
with helper-methods on the <a class="reference internal" href="api.html#Window" title="Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> object for generating the
appropriate boundary references:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Window.CURRENT_ROW" title="Window.CURRENT_ROW"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Window.CURRENT_ROW</span></code></a> - attribute that references the current row.</li>
<li><a class="reference internal" href="api.html#Window.preceding" title="Window.preceding"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Window.preceding()</span></code></a> - specify number of row(s) preceding, or omit
number to indicate <strong>all</strong> preceding rows.</li>
<li><a class="reference internal" href="api.html#Window.following" title="Window.following"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Window.following()</span></code></a> - specify number of row(s) following, or omit
number to indicate <strong>all</strong> following rows.</li>
</ul>
<p>To examine how boundaries work, we’ll calculate a running total of the
<code class="docutils literal notranslate"><span class="pre">value</span></code> column, ordered with respect to <code class="docutils literal notranslate"><span class="pre">id</span></code>, <strong>but</strong> we’ll only look the
running total of the current row and it’s two preceding rows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
        <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
        <span class="n">start</span><span class="o">=</span><span class="n">Window</span><span class="o">.</span><span class="n">preceding</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="n">Window</span><span class="o">.</span><span class="n">CURRENT_ROW</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rsum&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">rsum</span><span class="p">)</span>

<span class="c1"># 1    10.    10.</span>
<span class="c1"># 1    20.    30.  -- (20 + 10)</span>
<span class="c1"># 2     1.    31.  -- (1 + 20 + 10)</span>
<span class="c1"># 2     3.    24.  -- (3 + 1 + 20)</span>
<span class="c1"># 3   100    104.  -- (100 + 3 + 1)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Technically we did not need to specify the <code class="docutils literal notranslate"><span class="pre">end=Window.CURRENT</span></code> because
that is the default. It was shown in the example for demonstration.</p>
</div>
<p>Let’s look at another example. In this example we will calculate the “opposite”
of a running total, in which the total sum of all values is decreased by the
value of the samples, ordered by <code class="docutils literal notranslate"><span class="pre">id</span></code>. To accomplish this, we’ll calculate
the sum from the current row to the last row.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
        <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
        <span class="n">start</span><span class="o">=</span><span class="n">Window</span><span class="o">.</span><span class="n">CURRENT_ROW</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">Window</span><span class="o">.</span><span class="n">following</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rsum&#39;</span><span class="p">))</span>

<span class="c1"># 1    10.   134.  -- (10 + 20 + 1 + 3 + 100)</span>
<span class="c1"># 1    20.   124.  -- (20 + 1 + 3 + 100)</span>
<span class="c1"># 2     1.   104.  -- (1 + 3 + 100)</span>
<span class="c1"># 2     3.   103.  -- (3 + 100)</span>
<span class="c1"># 3   100    100.  -- (100)</span>
</pre></div>
</div>
</div>
<div class="section" id="filtered-aggregates">
<h3>Filtered Aggregates<a class="headerlink" href="#filtered-aggregates" title="Permalink to this headline">¶</a></h3>
<p>Aggregate functions may also support filter functions (Postgres and Sqlite
3.25+), which get translated into a <code class="docutils literal notranslate"><span class="pre">FILTER</span> <span class="pre">(WHERE...)</span></code> clause. Filter
expressions are added to an aggregate function with the
<a class="reference internal" href="api.html#Function.filter" title="Function.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Function.filter()</span></code></a> method.</p>
<p>For an example, we will calculate the running sum of the <code class="docutils literal notranslate"><span class="pre">value</span></code> field with
respect to the <code class="docutils literal notranslate"><span class="pre">id</span></code>, but we will filter-out any samples whose <code class="docutils literal notranslate"><span class="pre">counter=2</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
        <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;csum&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">csum</span><span class="p">)</span>

<span class="c1"># 1    10.    10.</span>
<span class="c1"># 1    20.    30.</span>
<span class="c1"># 2     1.    30.</span>
<span class="c1"># 2     3.    30.</span>
<span class="c1"># 3   100    130.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The call to <a class="reference internal" href="api.html#Function.filter" title="Function.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">filter()</span></code></a> must precede the call to
<a class="reference internal" href="api.html#Function.over" title="Function.over"><code class="xref py py-meth docutils literal notranslate"><span class="pre">over()</span></code></a>.</p>
</div>
</div>
<div class="section" id="reusing-window-definitions">
<h3>Reusing Window Definitions<a class="headerlink" href="#reusing-window-definitions" title="Permalink to this headline">¶</a></h3>
<p>If you intend to use the same window definition for multiple aggregates, you
can create a <a class="reference internal" href="api.html#Window" title="Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> object. The <a class="reference internal" href="api.html#Window" title="Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> object takes the
same parameters as <a class="reference internal" href="api.html#Function.over" title="Function.over"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Function.over()</span></code></a>, and can be passed to the
<code class="docutils literal notranslate"><span class="pre">over()</span></code> method in-place of the individual parameters.</p>
<p>Here we’ll declare a single window, ordered with respect to the sample <code class="docutils literal notranslate"><span class="pre">id</span></code>,
and call several window functions using that window definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">win</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">LEAD</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">win</span><span class="p">),</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">LAG</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">win</span><span class="p">),</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>  <span class="c1"># Include our window definition in query.</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">tuples</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="c1"># counter  value  lead()  lag()  sum()</span>
<span class="c1"># 1          10.     20.   NULL    10.</span>
<span class="c1"># 1          20.      1.    10.    30.</span>
<span class="c1"># 2           1.      3.    20.    31.</span>
<span class="c1"># 2           3.    100.     1.    34.</span>
<span class="c1"># 3         100.    NULL     3.   134.</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-window-definitions">
<h3>Multiple window definitions<a class="headerlink" href="#multiple-window-definitions" title="Permalink to this headline">¶</a></h3>
<p>In the previous example, we saw how to declare a <a class="reference internal" href="api.html#Window" title="Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> definition
and re-use it for multiple different aggregations. You can include as many
window definitions as you need in your queries, but it is necessary to ensure
each window has a unique alias:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">w1</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;w1&#39;</span><span class="p">)</span>
<span class="n">w2</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;w2&#39;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rsum&#39;</span><span class="p">),</span>  <span class="c1"># Running total.</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">AVG</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;cavg&#39;</span><span class="p">)</span>   <span class="c1"># Avg per category.</span>
<span class="p">)</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>  <span class="c1"># Include our window definitions.</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">rsum</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">cavg</span><span class="p">)</span>

<span class="c1"># counter  value   rsum     cavg</span>
<span class="c1"># 1          10.     10.     15.</span>
<span class="c1"># 1          20.     30.     15.</span>
<span class="c1"># 2           1.     31.      2.</span>
<span class="c1"># 2           3.     34.      2.</span>
<span class="c1"># 3         100     134.    100.</span>
</pre></div>
</div>
</div>
<div class="section" id="frame-types-range-vs-rows">
<span id="window-frame-types"></span><h3>Frame types: RANGE vs ROWS<a class="headerlink" href="#frame-types-range-vs-rows" title="Permalink to this headline">¶</a></h3>
<p>Depending on the frame type, the database will process ordered groups
differently. Let’s create two additional <code class="docutils literal notranslate"><span class="pre">Sample</span></code> rows to visualize the
difference:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Sample</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">counter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
<span class="go">&lt;Sample 6&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Sample</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">counter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="go">&lt;Sample 7&gt;</span>
</pre></div>
</div>
<p>Our table now contains:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="47%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">id</th>
<th class="head">counter</th>
<th class="head">value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>1</td>
<td>10.0</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>1</td>
<td>20.0</td>
</tr>
<tr class="row-even"><td>3</td>
<td>2</td>
<td>1.0</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>2</td>
<td>3.0</td>
</tr>
<tr class="row-even"><td>5</td>
<td>3</td>
<td>100.0</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>1</td>
<td>20.0</td>
</tr>
<tr class="row-even"><td>7</td>
<td>2</td>
<td>1.0</td>
</tr>
</tbody>
</table>
<p>Let’s examine the difference by calculating a “running sum” of the samples,
ordered with respect to the <code class="docutils literal notranslate"><span class="pre">counter</span></code> and <code class="docutils literal notranslate"><span class="pre">value</span></code> fields. To specify the
frame type, we can use either:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Window.RANGE" title="Window.RANGE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Window.RANGE</span></code></a></li>
<li><a class="reference internal" href="api.html#Window.ROWS" title="Window.ROWS"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Window.ROWS</span></code></a></li>
</ul>
<p>The behavior of <a class="reference internal" href="api.html#Window.RANGE" title="Window.RANGE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">RANGE</span></code></a>, when there are logical duplicates,
may lead to unexpected results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
        <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">],</span>
        <span class="n">frame_type</span><span class="o">=</span><span class="n">Window</span><span class="o">.</span><span class="n">RANGE</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rsum&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">rsum</span><span class="p">)</span>

<span class="c1"># counter  value   rsum</span>
<span class="c1"># 1          10.     10.</span>
<span class="c1"># 1          20.     50.</span>
<span class="c1"># 1          20.     50.</span>
<span class="c1"># 2           1.     52.</span>
<span class="c1"># 2           1.     52.</span>
<span class="c1"># 2           3.     55.</span>
<span class="c1"># 3         100     155.</span>
</pre></div>
</div>
<p>With the inclusion of the new rows we now have some rows that have duplicate
<code class="docutils literal notranslate"><span class="pre">category</span></code> and <code class="docutils literal notranslate"><span class="pre">value</span></code> values. The <a class="reference internal" href="api.html#Window.RANGE" title="Window.RANGE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">RANGE</span></code></a> frame type
causes these duplicates to be evaluated together rather than separately.</p>
<p>The more expected result can be achieved by using <a class="reference internal" href="api.html#Window.ROWS" title="Window.ROWS"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ROWS</span></code></a> as
the frame-type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
        <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">],</span>
        <span class="n">frame_type</span><span class="o">=</span><span class="n">Window</span><span class="o">.</span><span class="n">ROWS</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rsum&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">rsum</span><span class="p">)</span>

<span class="c1"># counter  value   rsum</span>
<span class="c1"># 1          10.     10.</span>
<span class="c1"># 1          20.     30.</span>
<span class="c1"># 1          20.     50.</span>
<span class="c1"># 2           1.     51.</span>
<span class="c1"># 2           1.     52.</span>
<span class="c1"># 2           3.     55.</span>
<span class="c1"># 3         100     155.</span>
</pre></div>
</div>
<p>Peewee uses these rules for determining what frame-type to use:</p>
<ul class="simple">
<li>If the user specifies a <code class="docutils literal notranslate"><span class="pre">frame_type</span></code>, that frame type will be used.</li>
<li>If <code class="docutils literal notranslate"><span class="pre">start</span></code> and/or <code class="docutils literal notranslate"><span class="pre">end</span></code> boundaries are specified Peewee will default to
using <code class="docutils literal notranslate"><span class="pre">ROWS</span></code>.</li>
<li>If the user did not specify frame type or start/end boundaries, Peewee will
use the database default, which is <code class="docutils literal notranslate"><span class="pre">RANGE</span></code>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For information about the window function APIs, see:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Function.over" title="Function.over"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Function.over()</span></code></a></li>
<li><a class="reference internal" href="api.html#Function.filter" title="Function.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Function.filter()</span></code></a></li>
<li><a class="reference internal" href="api.html#Window" title="Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a></li>
</ul>
<p class="last">For general information on window functions, the
<a class="reference external" href="http://www.postgresql.org/docs/9.1/static/tutorial-window.html">postgresql docs</a>.
have a good overview.</p>
</div>
</div>
</div>
<div class="section" id="retrieving-row-tuples-dictionaries-namedtuples">
<h2>Retrieving row tuples / dictionaries / namedtuples<a class="headerlink" href="#retrieving-row-tuples-dictionaries-namedtuples" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you do not need the overhead of creating model instances and simply
want to iterate over the row data without needing all the APIs provided
<a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code></a>. To do this, use:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#BaseQuery.dicts" title="BaseQuery.dicts"><code class="xref py py-meth docutils literal notranslate"><span class="pre">dicts()</span></code></a></li>
<li><a class="reference internal" href="api.html#BaseQuery.namedtuples" title="BaseQuery.namedtuples"><code class="xref py py-meth docutils literal notranslate"><span class="pre">namedtuples()</span></code></a></li>
<li><a class="reference internal" href="api.html#BaseQuery.tuples" title="BaseQuery.tuples"><code class="xref py py-meth docutils literal notranslate"><span class="pre">tuples()</span></code></a></li>
<li><a class="reference internal" href="api.html#BaseQuery.objects" title="BaseQuery.objects"><code class="xref py py-meth docutils literal notranslate"><span class="pre">objects()</span></code></a> – accepts an arbitrary constructor function
which is called with the row tuple.</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stat</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
         <span class="o">.</span><span class="n">tuples</span><span class="p">())</span>

<span class="c1"># iterate over a list of 2-tuples containing the url and count</span>
<span class="k">for</span> <span class="n">stat_url</span><span class="p">,</span> <span class="n">stat_count</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">stat_url</span><span class="p">,</span> <span class="n">stat_count</span><span class="p">)</span>
</pre></div>
</div>
<p>Similarly, you can return the rows from the cursor as dictionaries using
<a class="reference internal" href="api.html#BaseQuery.dicts" title="BaseQuery.dicts"><code class="xref py py-meth docutils literal notranslate"><span class="pre">dicts()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stat</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;ct&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
         <span class="o">.</span><span class="n">dicts</span><span class="p">())</span>

<span class="c1"># iterate over a list of 2-tuples containing the url and count</span>
<span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="returning-clause">
<span id="id6"></span><h2>Returning Clause<a class="headerlink" href="#returning-clause" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="api.html#PostgresqlDatabase" title="PostgresqlDatabase"><code class="xref py py-class docutils literal notranslate"><span class="pre">PostgresqlDatabase</span></code></a> supports a <code class="docutils literal notranslate"><span class="pre">RETURNING</span></code> clause on <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>,
<code class="docutils literal notranslate"><span class="pre">INSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> queries. Specifying a <code class="docutils literal notranslate"><span class="pre">RETURNING</span></code> clause allows you
to iterate over the rows accessed by the query.</p>
<p>For example, let’s say you have an <a class="reference internal" href="api.html#Update" title="Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> that deactivates all
user accounts whose registration has expired. After deactivating them, you want
to send each user an email letting them know their account was deactivated.
Rather than writing two queries, a <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> and an <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, you can do
this in a single <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> query with a <code class="docutils literal notranslate"><span class="pre">RETURNING</span></code> clause:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">registration_expired</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
         <span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>

<span class="c1"># Send an email to every user that was deactivated.</span>
<span class="k">for</span> <span class="n">deactivate_user</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="n">send_deactivation_email</span><span class="p">(</span><span class="n">deactivated_user</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">RETURNING</span></code> clause is also available on <a class="reference internal" href="api.html#Insert" title="Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> and
<a class="reference internal" href="api.html#Delete" title="Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a>. When used with <code class="docutils literal notranslate"><span class="pre">INSERT</span></code>, the newly-created rows will be
returned. When used with <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>, the deleted rows will be returned.</p>
<p>The only limitation of the <code class="docutils literal notranslate"><span class="pre">RETURNING</span></code> clause is that it can only consist of
columns from tables listed in the query’s <code class="docutils literal notranslate"><span class="pre">FROM</span></code> clause. To select all
columns from a particular table, you can simply pass in the <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code></a>
class.</p>
</div>
<div class="section" id="common-table-expressions">
<span id="cte"></span><h2>Common Table Expressions<a class="headerlink" href="#common-table-expressions" title="Permalink to this headline">¶</a></h2>
<p>Peewee supports the inclusion of common table expressions (CTEs) in all types
of queries. CTEs may be useful for:</p>
<ul class="simple">
<li>Factoring out a common subquery.</li>
<li>Grouping or filtering by a column derived in the CTE’s result set.</li>
<li>Writing recursive queries.</li>
</ul>
<p>To declare a <a class="reference internal" href="api.html#Select" title="Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> query for use as a CTE, use
<a class="reference internal" href="api.html#SelectQuery.cte" title="SelectQuery.cte"><code class="xref py py-meth docutils literal notranslate"><span class="pre">cte()</span></code></a> method, which wraps the query in a <a class="reference internal" href="api.html#CTE" title="CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a>
object. To indicate that a <a class="reference internal" href="api.html#CTE" title="CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a> should be included as part of a
query, use the <a class="reference internal" href="api.html#Query.with_cte" title="Query.with_cte"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.with_cte()</span></code></a> method, passing a list of CTE objects.</p>
<div class="section" id="simple-example">
<h3>Simple Example<a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h3>
<p>For an example, let’s say we have some data points that consist of a key and a
floating-point value. Let’s define our model and populate some test data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sample</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">,</span> <span class="mf">2.9</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)))</span>

<span class="c1"># Populate data.</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">Sample</span><span class="o">.</span><span class="n">insert_many</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span>
                       <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">Sample</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>Let’s use a CTE to calculate, for each distinct key, which values were
above-average for that key.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># First we&#39;ll declare the query that will be used as a CTE. This query</span>
<span class="c1"># simply determines the average value for each key.</span>
<span class="n">cte</span> <span class="o">=</span> <span class="p">(</span><span class="n">Sample</span>
       <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">AVG</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;avg_value&#39;</span><span class="p">))</span>
       <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
       <span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="s1">&#39;key_avgs&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_value&#39;</span><span class="p">)))</span>

<span class="c1"># Now we&#39;ll query the sample table, using our CTE to find rows whose value</span>
<span class="c1"># exceeds the average for the given key. We&#39;ll calculate how far above the</span>
<span class="c1"># average the given sample&#39;s value is, as well.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Sample</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cte</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">avg_value</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
         <span class="o">.</span><span class="n">with_cte</span><span class="p">(</span><span class="n">cte</span><span class="p">))</span>
</pre></div>
</div>
<p>We can iterate over the samples returned by the query to see which samples had
above-average values for their given group:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="go"># &#39;a&#39;, 1.75</span>
<span class="go"># &#39;b&#39;, 2.7</span>
<span class="go"># &#39;b&#39;, 2.9</span>
</pre></div>
</div>
</div>
<div class="section" id="complex-example">
<h3>Complex Example<a class="headerlink" href="#complex-example" title="Permalink to this headline">¶</a></h3>
<p>For a more complete example, let’s consider the following query which uses
multiple CTEs to find per-product sales totals in only the top sales regions.
Our model looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">()</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">quantity</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
</pre></div>
</div>
<p>Here is how the query might be written in SQL. This example can be found in
the <a class="reference external" href="https://www.postgresql.org/docs/current/static/queries-with.html">postgresql documentation</a>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">regional_sales</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">region</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total_sales</span>
    <span class="k">FROM</span> <span class="n">orders</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">region</span>
  <span class="p">),</span> <span class="n">top_regions</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">region</span>
    <span class="k">FROM</span> <span class="n">regional_sales</span>
    <span class="k">WHERE</span> <span class="n">total_sales</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">SUM</span><span class="p">(</span><span class="n">total_sales</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span> <span class="k">FROM</span> <span class="n">regional_sales</span><span class="p">)</span>
  <span class="p">)</span>
<span class="k">SELECT</span> <span class="n">region</span><span class="p">,</span>
       <span class="n">product</span><span class="p">,</span>
       <span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">AS</span> <span class="n">product_units</span><span class="p">,</span>
       <span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">AS</span> <span class="n">product_sales</span>
<span class="k">FROM</span> <span class="n">orders</span>
<span class="k">WHERE</span> <span class="n">region</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">region</span> <span class="k">FROM</span> <span class="n">top_regions</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">region</span><span class="p">,</span> <span class="n">product</span><span class="p">;</span>
</pre></div>
</div>
<p>With Peewee, we would write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reg_sales</span> <span class="o">=</span> <span class="p">(</span><span class="n">Order</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                     <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;total_sales&#39;</span><span class="p">))</span>
             <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
             <span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="s1">&#39;regional_sales&#39;</span><span class="p">))</span>

<span class="n">top_regions</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_sales</span>
               <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">reg_sales</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
               <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">reg_sales</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">total_sales</span> <span class="o">&gt;</span> <span class="p">(</span>
                   <span class="n">reg_sales</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">reg_sales</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">total_sales</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)))</span>
               <span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="s1">&#39;top_regions&#39;</span><span class="p">))</span>

<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Order</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                 <span class="n">Order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
                 <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;product_units&#39;</span><span class="p">),</span>
                 <span class="n">fn</span><span class="o">.</span><span class="n">SUM</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;product_sales&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">top_regions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">top_regions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">region</span><span class="p">)))</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">Order</span><span class="o">.</span><span class="n">product</span><span class="p">)</span>
         <span class="o">.</span><span class="n">with_cte</span><span class="p">(</span><span class="n">regional_sales</span><span class="p">,</span> <span class="n">top_regions</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="recursive-ctes">
<h3>Recursive CTEs<a class="headerlink" href="#recursive-ctes" title="Permalink to this headline">¶</a></h3>
<p>Peewee supports recursive CTEs. Recursive CTEs can be useful when, for example,
you have a tree data-structure represented by a parent-link foreign key.
Suppose, for example, that we have a hierarchy of categories for an online
bookstore. We wish to generate a table showing all categories and their
absolute depths, along with the path from the root to the category.</p>
<p>We’ll assume the following model definition, in which each category has a
foreign-key to its immediate parent category:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>To list all categories along with their depth and parents, we can use a
recursive CTE:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the base case of our recursive CTE. This will be categories that</span>
<span class="c1"># have a null parent foreign-key.</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">level</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
<span class="n">base_case</span> <span class="o">=</span> <span class="p">(</span><span class="n">Base</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
             <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span>
             <span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="c1"># Define the recursive terms.</span>
<span class="n">RTerm</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">rlevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_case</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
<span class="n">rpath</span> <span class="o">=</span> <span class="n">base_case</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">RTerm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
<span class="n">recursive</span> <span class="o">=</span> <span class="p">(</span><span class="n">RTerm</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">RTerm</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">RTerm</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">rlevel</span><span class="p">,</span> <span class="n">rpath</span><span class="p">)</span>
             <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_case</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">RTerm</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">base_case</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)))</span>

<span class="c1"># The recursive CTE is created by taking the base case and UNION ALL with</span>
<span class="c1"># the recursive term.</span>
<span class="n">cte</span> <span class="o">=</span> <span class="n">base_case</span><span class="o">.</span><span class="n">union_all</span><span class="p">(</span><span class="n">recursive</span><span class="p">)</span>

<span class="c1"># We will now query from the CTE to get the categories, their levels,  and</span>
<span class="c1"># their paths.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">cte</span>
         <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

<span class="c1"># We can now iterate over a list of all categories and print their names,</span>
<span class="c1"># absolute levels, and path from root -&gt; category.</span>
<span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

<span class="c1"># Example output:</span>
<span class="c1"># root, 1, root</span>
<span class="c1"># p1, 2, root-&gt;p1</span>
<span class="c1"># c1-1, 3, root-&gt;p1-&gt;c1-1</span>
<span class="c1"># c1-2, 3, root-&gt;p1-&gt;c1-2</span>
<span class="c1"># p2, 2, root-&gt;p2</span>
<span class="c1"># c2-1, 3, root-&gt;p2-&gt;c2-1</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="foreign-keys-and-joins">
<h2>Foreign Keys and Joins<a class="headerlink" href="#foreign-keys-and-joins" title="Permalink to this headline">¶</a></h2>
<p>This section have been moved into its own document: <a class="reference internal" href="relationships.html#relationships"><span class="std std-ref">Relationships and Joins</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Querying</a><ul>
<li><a class="reference internal" href="#creating-a-new-record">Creating a new record</a></li>
<li><a class="reference internal" href="#bulk-inserts">Bulk inserts</a><ul>
<li><a class="reference internal" href="#inserting-rows-in-batches">Inserting rows in batches</a></li>
<li><a class="reference internal" href="#alternatives">Alternatives</a></li>
<li><a class="reference internal" href="#bulk-loading-from-another-table">Bulk-loading from another table</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updating-existing-records">Updating existing records</a></li>
<li><a class="reference internal" href="#atomic-updates">Atomic updates</a><ul>
<li><a class="reference internal" href="#upsert">Upsert</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deleting-records">Deleting records</a></li>
<li><a class="reference internal" href="#selecting-a-single-record">Selecting a single record</a></li>
<li><a class="reference internal" href="#create-or-get">Create or get</a></li>
<li><a class="reference internal" href="#selecting-multiple-records">Selecting multiple records</a><ul>
<li><a class="reference internal" href="#iterating-over-large-result-sets">Iterating over large result-sets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#filtering-records">Filtering records</a><ul>
<li><a class="reference internal" href="#more-query-examples">More query examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sorting-records">Sorting records</a></li>
<li><a class="reference internal" href="#getting-random-records">Getting random records</a></li>
<li><a class="reference internal" href="#paginating-records">Paginating records</a></li>
<li><a class="reference internal" href="#counting-records">Counting records</a></li>
<li><a class="reference internal" href="#aggregating-records">Aggregating records</a></li>
<li><a class="reference internal" href="#retrieving-scalar-values">Retrieving Scalar Values</a></li>
<li><a class="reference internal" href="#window-functions">Window functions</a><ul>
<li><a class="reference internal" href="#ordered-windows">Ordered Windows</a></li>
<li><a class="reference internal" href="#partitioned-windows">Partitioned Windows</a></li>
<li><a class="reference internal" href="#bounded-windows">Bounded windows</a></li>
<li><a class="reference internal" href="#filtered-aggregates">Filtered Aggregates</a></li>
<li><a class="reference internal" href="#reusing-window-definitions">Reusing Window Definitions</a></li>
<li><a class="reference internal" href="#multiple-window-definitions">Multiple window definitions</a></li>
<li><a class="reference internal" href="#frame-types-range-vs-rows">Frame types: RANGE vs ROWS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#retrieving-row-tuples-dictionaries-namedtuples">Retrieving row tuples / dictionaries / namedtuples</a></li>
<li><a class="reference internal" href="#returning-clause">Returning Clause</a></li>
<li><a class="reference internal" href="#common-table-expressions">Common Table Expressions</a><ul>
<li><a class="reference internal" href="#simple-example">Simple Example</a></li>
<li><a class="reference internal" href="#complex-example">Complex Example</a></li>
<li><a class="reference internal" href="#recursive-ctes">Recursive CTEs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#foreign-keys-and-joins">Foreign Keys and Joins</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="models.html"
                        title="previous chapter">Models and Fields</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="query_operators.html"
                        title="next chapter">Query operators</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/peewee/querying.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="query_operators.html" title="Query operators"
             >next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Models and Fields"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">peewee 3.6.4 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright charles leifer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>