<!doctype html>
<html>
<body><!-- APPUID: 28b06d4a-4875-45bb-bde3-fbd0fbbfbf7f -->
<style>
body,input,select{font:normal 14pt Arial}
th,td{padding:0.4em 0.2em; text-align:left}
tr:not(:first-child)>th{padding-top:1em}
table{margin:0 0 1em 0}
input[type=text],input[type=number]{text-align:center}
input[type=number]{max-width:5em}
table {border-collapse:collapse}
#log td {border:1px solid}
#gmap {width:100%; height:250px}
</style>
<script>
var hours = [];
for(var i=0; i<24; i++) hours.push("<option value="+i+">"+i+":00");
hours = hours.join("");
function wr(s){
  document.write(s);
}
</script>
<form name=fm action="#" methd=get onsubmit="return doSubmit();">
<table cellspacing=0 border=0>
<tr><th colspan=2>Use this location for weather info:
<tr><td>Latitude:<td><input type=text name=lat size=10 min="-90" max=90>
<tr><td>Longitude:<td><input type=text name=lon size=10 min="-180" max=180>
<tr><td colspan=2><a href="javascript:void(0);" onclick="showMap(this);">Select using Google Maps...</a>
<tr><th colspan=2>Only fetch data between the hours of:
<tr><td>Begin fetch:<td><select name=updBegin><script>wr(hours);</script></select>
<tr><td>End fetch:<td><select name=updEnd><script>wr(hours);</script></select>
<tr><td>Fetch every:<td><input type=number name=updEvery size=2 value=2> hours
<tr><td colspan=2><small>(To disable fetching, set begin = end)</small>
<tr><th colspan=2>Appearance:
<tr><td>Tomorrow:<td>After <select name=showTmr><script>wr(hours);</script></select> show tomorrow's weather
<tr><td>Background:<td><input type=checkbox name=theme> White colour
<tr><td>&deg;C/&deg;F:<td><input type=checkbox name=celsius> Celsius
<tr><th colspan=2><input type=submit value=Save>
<tr><td colspan=2><small>Weather data provided by openweathermap.org</small>
</table>

<hr>
<p>Server health: <input type=text name=fail size=2>
<br><small>Health starts at 10 and each error reduces it by 1.</small></p>
</form>

<script>
var obj = {};
location.search.replace(/\b(\w+)=([^&]*)/g, function(s,n,v) {obj[n] = v});
var fm=document.fm, el;
for(var i=0;i<fm.elements.length; i++) {
  el = fm.elements[i];
  if(el.name) el[el.type=="checkbox"?"checked":"value"] = obj[el.name]*1;
}
fm = ["<table cellspacing=0 border=0 id=log><tr><th colspan=2>Server log"];
for(var i=0; el=obj["lg"+i]; i++) {
  fm.push(el.replace(/^(.+)-(\d\d)(\d\d)(\d\d)$/, "<tr><td>$2 $3:$4<td>$1").replace(/\+/g," "));
}
fm.push("<tr><td colspan=2><input type=checkbox name=clearLog>Delete log");
document.fm.appendChild(document.createElement("div")).innerHTML=fm.join("")+"<\/table>";

function doSubmit() {
  obj = {};
  fm=document.fm;
  fm.updEvery.value=Math.max(Math.min(fm.updEvery.value,Math.abs(fm.updBegin.value*1-fm.updEnd.value*1)),1)||1;
  fm.fail.value=Math.max(Math.min(fm.fail.value,10),1)||1;
  for(var i=0;i<fm.elements.length; i++) {
    el = fm.elements[i];
    if(el.name) obj[el.name]=(el.type!="checkbox")?el.value*1:el.checked?1:0;
  }
  location="pebblejs://close#"+encodeURIComponent(JSON.stringify(obj));
  return false;
}

function showMap(a) {
  var s=document.createElement("script");
  s.type="text/javascript";
  s.src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyCHmDLIKQL8lMFOM6EERM-WNMMMCM6kcmc&signed_in=true&callback=initMap";
  document.body.appendChild(s);

  var d=a.parentNode.insertBefore(document.createElement("div"), a);
  d.id="gmap";
  a.parentNode.removeChild(a);
}
var gMap;
function initMap() {
  if(gMap) return;
  gMap=new google.maps.Map(document.getElementById("gmap"), {zoom:10, center:new google.maps.LatLng(obj.lat||37.333, obj.lon||-122)});
  google.maps.event.addListener(gMap, "center_changed", function() {
    var c=gMap.getCenter();
    if(c.lat)document.fm.lat.value=c.lat();
    if(c.lng)document.fm.lon.value=c.lng();
  });
}
</script>
</body>
</html>
